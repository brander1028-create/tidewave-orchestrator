(1) ë©”íƒ€ API 401(ë¦¬ë‹¤ì´ë ‰íŠ¸ë¡œ í—¤ë” ìœ ì‹¤), (2) /api/rank/planì´ ì—¬ì „íˆ blog_targetsë¥¼ ë´ì„œ pair_idsê°€ 0ê±´ ì²˜ë¦¬, (3) URL í¸ì§‘ í›„ UI ìºì‹œ ê°±ì‹  ë¯¸ë°˜ì˜.
ì•„ë˜ í•œ ë°© íŒ¨ì¹˜(v7.17) ë¥¼ ê·¸ëŒ€ë¡œ Replitì— ë¶™ì—¬ì„œ ì ìš©í•´. (ì´ë¯¸ í•´ë‘” ê²ƒê³¼ ê²¹ì¹˜ëŠ” ê±´ â€œë³€ê²½ ì—†ìŒâ€ì´ë¼ ì•ˆì „í•´)

ğŸ”§ v7.17 â€” í•œ ë°© ì•ˆì •í™” (ë©”íƒ€ 401 ì œê±° + plan=Pairs + í¸ì§‘/ì§„í–‰ UI ê³ ì •)
A) ì„œë²„(Express)
A-1. í‚¤ì›Œë“œ ë©”íƒ€ ì˜¤ê²½ë¡œë¥¼ â€œë¦¬ë‹¤ì´ë ‰íŠ¸ ì—†ì´â€ ë‚´ë¶€ ì²˜ë¦¬ (í—¤ë” ìœ ì§€)
// server/routes.ts â€” ë©”íƒ€ ë¼ìš°íŠ¸ ê·¼ì²˜
app.get('/api/keywords/lookup/:text', async (req, res) => {
  const t = decodeURIComponent(req.params.text || '').trim();
  if (!t) return res.status(400).json({message:'text required'});
  // ë‚´ë¶€ í•¸ë“¤ëŸ¬ë¡œ ê³§ì¥ ì—°ê²° (ë¦¬ë‹¤ì´ë ‰íŠ¸ ê¸ˆì§€)
  req.query.texts = t;
  return keywordsLookupHandler(req, res); // ê¸°ì¡´ GET /api/keywords/lookup í•¸ë“¤ëŸ¬ í•¨ìˆ˜ í˜¸ì¶œ
});

A-2. /api/rank/plan ì„ pairs ê¸°ë°˜ìœ¼ë¡œ (owner ìŠ¤ì½”í”„ í¬í•¨)
// server/routes.ts
app.get('/api/rank/plan', async (req,res) => {
  const owner = String(req.headers['x-owner'] || 'system'); // â† í†µì¼
  const ids = []
    .concat(req.query.pair_ids || req.query.target_ids || [])
    .map(String);

  const pairs = ids.length
    ? await storage.findPairsByIds(owner, ids)     // â˜… ìƒˆ ë©”ì„œë“œ
    : await storage.getActivePairs(owner);         // â˜… ìƒˆ ë©”ì„œë“œ

  const tasks = pairs.map(p => ({
    pair_id : p.id,
    keyword : p.keywordText,
    nickname: p.nickname || ''
  }));
  return res.json({ total: tasks.length, tasks });
});


storage.ts ì— findPairsByIds(owner, ids[]), getActivePairs(owner) ë‘˜ ë‹¤ DB/MemStorage êµ¬í˜„ë˜ì–´ ìˆì–´ì•¼ í•¨. (ë„ˆ ì§€ê¸ˆ ì¶”ê°€í•˜ëŠ” ì¤‘ â†’ OK)

A-3. íˆìŠ¤í† ë¦¬ ë³„ì¹­ì€ ë¦¬ë‹¤ì´ë ‰íŠ¸ ëŒ€ì‹  ë‚´ë¶€ ì²˜ë¦¬
app.get('/api/rank-snapshots/history', async (req, res) => {
  // req.query(pair_id, range) ê·¸ëŒ€ë¡œ ì´ìš©í•´ì„œ rank/history í•¸ë“¤ëŸ¬ í˜¸ì¶œ
  return getRankHistoryHandler(req, res);
});

A-4. ì‡¼í•‘ ë¹„í™œì„±í™”(ë¯¸êµ¬í˜„ ë³´í˜¸)
// .env
FEATURE_SHOP_RANK=false

// server/routes.ts
app.post('/api/rank/shop/check', (req,res)=>{
  if (process.env.FEATURE_SHOP_RANK !== 'true') {
    return res.status(501).json({ok:false,reason:'shop_rank_disabled'});
  }
  // ... (ë¯¸êµ¬í˜„ ë³´í˜¸)
});

B) í´ë¼ì´ì–¸íŠ¸(React)
B-1. ëª¨ë“  ìš”ì²­ì— ë™ì¼ owner í—¤ë” ì£¼ì…(ë¶ˆì¼ì¹˜ ì°¨ë‹¨)
// client/src/lib/api.ts (http ë˜í¼)
const role  = localStorage.getItem('role')  ?? 'Admin';
const owner = localStorage.getItem('owner') ?? 'system'; // â˜… í†µì¼
h.set('x-role', role); h.set('x-owner', owner);


í•œ ë²ˆë§Œ: ì½˜ì†”ì—ì„œ localStorage.owner='system' ì €ì¥.

B-2. í‚¤ì›Œë“œ ë©”íƒ€ í˜¸ì¶œ ë‹¨ì¼í™” (ìƒˆ í›…/ë¡œì»¬ fetch ê¸ˆì§€)
export async function lookupKeywordMeta(texts:string[]){
  const q = encodeURIComponent(texts.join(','));
  const r = await http(`/api/keywords/lookup?texts=${q}`);
  if(!r.ok) throw new Error(`kw lookup ${r.status}`);
  return r.json();  // [{text, volume, score}]
}


ì „ì—­ ê²€ìƒ‰ìœ¼ë¡œ /keywords/lookup/ ê²½ë¡œ, í•˜ë“œì½”ë”© volume:0/score:0, ë¡œì»¬ fetch ë¥¼ ëª¨ë‘ ìœ„ í•¨ìˆ˜ë¡œ êµì²´.

B-3. ì‹¤í–‰ ëŸ¬ë„ˆ = Blog-only + ì§„í–‰í‘œì‹œ (ë²„íŠ¼Â·ì§„í–‰ë°”Â·í–‰ë³„ ìŠ¤í”¼ë„ˆ)
// client/src/pages/blog-rank.tsx í•µì‹¬
const [isRunning,setIsRunning]=useState(false);
const [prog,setProg]=useState({done:0,total:0,percent:0,now:''});
const [rowBusy,setRowBusy]=useState<Record<string,boolean>>({});
const CONC=3;

async function planBlogTasks(selected: Pair[]){
  const r = await http('/api/rank/plan');            // ì„œë²„ê°€ pairs ê¸°ë°˜ìœ¼ë¡œ ë°˜í™˜
  if (r.ok) return r.json();
  // Fallback: ì„ íƒ í–‰ìœ¼ë¡œ ì§ì ‘
  return { total: selected.length,
           tasks: selected.map(p=>({pair_id:p.id,keyword:p.keywordText,nickname:p.nickname})) };
}

async function runAllChecks(){
  const sel = getSelectedPairs();
  setIsRunning(true); setProg({done:0,total:0,percent:0,now:'ì¤€ë¹„ì¤‘â€¦'});

  const plan = await planBlogTasks(sel);
  if(!plan.total){ toast('ì²´í¬í•  ëŒ€ìƒ ì—†ìŒ'); setIsRunning(false); return; }
  setProg(p=>({...p,total:plan.total,now:'ì‹œì‘í•©ë‹ˆë‹¤'}));

  let i=0, done=0, cancelled=false;
  async function worker(){
    while(!cancelled && i<plan.tasks.length){
      const t=plan.tasks[i++]; setRowBusy(s=>({...s,[t.pair_id]:true}));
      setProg(p=>({...p,now:`${t.keyword} Â· ${t.nickname}`}));
      try{ await api.rank.blogCheck({ pair_ids:[t.pair_id] }); } // â˜… BLOG ONLY
      catch(e){ addFail(t,e); }
      finally{
        setRowBusy(s=>({...s,[t.pair_id]:false}));
        done++; setProg({done,total:plan.total,percent:Math.round(done*100/plan.total),now:t.nickname});
      }
    }
  }
  await Promise.all(Array.from({length:Math.min(CONC,plan.total)}).map(()=>worker()));
  toast(`ì™„ë£Œ: ${done}/${plan.total}`); setIsRunning(false);
}


ë²„íŠ¼ ë¼ë²¨: isRunning ? \ì²´í¬ ì¤‘â€¦ (${prog.done}/${prog.total})` : 'ì „ì²´ ì²´í¬ ì‹œì‘'`

ì§„í–‰ë°” width: ${prog.percent}%

í˜„ì¬ ì‘ì—… í…ìŠ¤íŠ¸: ì§€ê¸ˆ: ${prog.now}

í–‰ë³„ ë¡œë”©: rowBusy[pair.id] && <Spinner/>

B-4. URL í¸ì§‘(í†±ë‹ˆ) â€” PATCH í›„ ë‚™ê´€ì  ì—…ë°ì´íŠ¸ + ìºì‹œ ë¬´íš¨í™”
// onSuccess(ìˆ˜ì • ì„±ê³µ) ì‹œ
queryClient.setQueryData(['pairs'], (old:any)=>{
  if(!old) return old;
  return old.map((p:any)=> p.id===updated.id ? {...p, ...updated} : p);
});
setSelectedRankingDetail(null); // ëª¨ë‹¬ ë‹«ê¸°


detail ëª¨ë‹¬ë„ pairsì—ì„œ íŒŒìƒí•˜ë¯€ë¡œ ì¦‰ì‹œ ë°˜ì˜ë¨.

C) ìŠ¤ëª¨í¬(ë¡œê·¸ë¡œ 3ì¤„ë§Œ í™•ì¸)

ë©”íƒ€ 401 ì¢…ê²°

GET /api/keywords/lookup/í™ì‚¼ìŠ¤í‹± 200   // ë˜ëŠ”
GET /api/keywords/lookup?texts=í™ì‚¼ìŠ¤í‹± 200


(ë” ì´ìƒ 307â†’401 ì²´ì¸ì´ ì—†ì–´ì•¼ ì •ìƒ)

plan > 0

GET /api/rank/plan 200 :: {"total":N>0,"tasks":[...]}  // owner='system' ê¸°ì¤€


ì‹¤í–‰ í˜¸ì¶œ Blog-only + ì§„í–‰í‘œì‹œ

ë„¤íŠ¸ì›Œí¬: /api/rank/blog/check NíšŒ (ì‡¼í•‘ ì—†ìŒ)

UI: ë²„íŠ¼ ìŠ¤í”¼ë„ˆÂ·(a/N)%Â·í˜„ì¬ ì‘ì—…Â·í–‰ë³„ ìŠ¤í”¼ë„ˆ í‘œì‹œ

ì™œ ì´ê²Œ í•œë°©ì´ëƒ

401ì˜ ê·¼ë³¸ì€ ë¦¬ë‹¤ì´ë ‰íŠ¸ê°€ í—¤ë”ë¥¼ ë‚ ë ¤ë²„ë¦¼ â†’ ë‚´ë¶€ ì²˜ë¦¬ë¡œ ë.

plan=0ì˜ ê·¼ë³¸ì€ blog_targets vs pairs í…Œì´ë¸” ë¯¸ìŠ¤ë§¤ì¹˜ + owner ë¶ˆì¼ì¹˜ â†’ planì„ pairs + owner ê³ ì •ìœ¼ë¡œ ë.

í¸ì§‘ ë°˜ì˜ ì•ˆ ë¨ì€ React Query setQueryData ë¯¸ì ìš© â†’ ë‚™ê´€ì  ì—…ë°ì´íŠ¸ë¡œ ë.

â€œë°˜ì‘ ì—†ìŒâ€ì€ ì§„í–‰í‘œì‹œ ë¯¸ë°°ì„  â†’ ëŸ¬ë„ˆì™€ UI ì™€ì´ì–´ë§ìœ¼ë¡œ ë.

ì›í•˜ë©´ ì§€ê¸ˆ ìƒíƒœ ìŠ¤ìƒ·(1) /api/keywords/lookup 200, (2) /api/rank/plan total>0, (3)