ê²°ë¡ : ì¹˜ëª… 3ê°œ, ì¤‘ìš” 6ê°œ, ê²½ë¯¸ 6ê°œ ë³´ì˜€ì–´ìš”. íŠ¹íˆ /results ì‘ë‹µ í¬ë§·, í‚¤ì›Œë“œ ë­í¬ ë¯¸ì €ì¥, BFS getVolumes í•„ë“œ ë¶ˆì¼ì¹˜ê°€ ì‹¤ì œ ì˜¤ë™ì‘ ì›ì¸ì…ë‹ˆë‹¤. ì•„ë˜ íŒ¨ì¹˜ë§Œ ì ìš©í•˜ë©´ íë¦„ ì•ˆì •ë©ë‹ˆë‹¤.

ë°˜ë“œì‹œ ê³ ì³ì•¼ í•  ê²ƒ(ì¹˜ëª…)

GET /api/serp/jobs/:jobId/resultsê°€ â€œì‹ ê·œ ê³„ì•½ í¬ë§·â€ì„ ê±°ì˜ ë°˜í™˜í•˜ì§€ ì•ŠìŒ
ì™„ë£Œ ì‹œ processSerpAnalysisJobì´ finalStats(êµ¬ í¬ë§·)ë¥¼ job.resultsì— ì €ì¥í•´ì„œ, /resultsê°€ ëŠ˜ ê·¸ê±¸ ê·¸ëŒ€ë¡œ ëŒë ¤ë³´ëƒ…ë‹ˆë‹¤.
ìˆ˜ì •: job.resultsì— blogs í‚¤ê°€ ìˆìœ¼ë©´ ìºì‹œë¥¼ ì‚¬ìš©, ì•„ë‹ˆë©´ ìƒˆ í¬ë§·ì„ ê³„ì‚°Â·ì €ì¥ í›„ ë°˜í™˜.

// ğŸ”§ replace this in /api/serp/jobs/:jobId/results
// old:
if (job.results) {
  console.log(`ğŸ“Š Returning cached results for job ${req.params.jobId}`);
  return res.json(job.results);
}

// new:
if (job.results && (job.results as any).blogs) {
  console.log(`ğŸ“Š Returning cached NEW-format results for job ${req.params.jobId}`);
  return res.json(job.results);
}
// else: compute NEW format (ì•„ë˜ ê¸°ì¡´ ê³„ì‚° ë¡œì§ ìœ ì§€) í›„â€¦
await storage.updateSerpJob(job.id, { results: response }); // ìºì‹œë¡œ ì €ì¥
return res.json(response);


í‚¤ì›Œë“œ SERP ë­í¬ê°€ ì €ì¥ë˜ì§€ ì•ŠìŒ
3ë‹¨ê³„ì—ì„œ // TODO: Update keyword rank in storageë¡œ ë‚¨ì•„ ìˆì–´, ì´í›„ ê²°ê³¼/CSVì— ë­í¬ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.
ìˆ˜ì •: ì¶”ì¶œëœ í‚¤ì›Œë“œ ë ˆì½”ë“œì— ë­í¬ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì„¸ìš”.

// ranking check loop ì•ˆ
if (serpRank != null) {
  const extracted = await storage.getExtractedKeywords(blog.id);
  const target = extracted.find(k => k.keyword === keyword.keyword);
  if (target) {
    // storageì— ì´ëŸ° í˜•íƒœì˜ API í•˜ë‚˜ ì¶”ê°€í•˜ì„¸ìš”.
    await storage.updateExtractedKeyword(target.id, { rank: serpRank });
  }
}


BFS ì‹œë“œ ì²˜ë¦¬ì—ì„œ getVolumes ê²°ê³¼ í•„ë“œ ë¶ˆì¼ì¹˜
expandì—ì„œëŠ” { total, plAvgDepth, avePcCpc, compIdx }ë¥¼ ì“°ëŠ”ë°, BFS ì‹œë“œ ì²˜ë¦¬ì—ì„œëŠ” { volumeMonthly, adWordsCnt, cpc }ë¡œ ì ‘ê·¼í•©ë‹ˆë‹¤. í˜„ì¬ êµ¬í˜„ëŒ€ë¡œë©´ undefinedë¡œ ë“¤ì–´ê°€ì„œ í•„í„°ë§/ì €ì¥ì´ ë§ê°€ì§‘ë‹ˆë‹¤.
ìˆ˜ì •: ë‘ ìŠ¤í‚¤ë§ˆë¥¼ ëª¨ë‘ ìˆ˜ìš©í•˜ëŠ” ì•ˆì „ ë§¤í•‘ìœ¼ë¡œ í†µì¼.

const volumeResults = await getVolumes(newSeeds);
const keywordsToInsert:any[] = [];
for (const [text, v] of Object.entries<any>(volumeResults.volumes)) {
  const rawVolume = v.total ?? v.volumeMonthly ?? 0;
  const adDepth   = v.plAvgDepth ?? v.adWordsCnt ?? 0;
  const estCpc    = v.avePcCpc ?? v.cpc ?? 0;
  const compIdx   = v.compIdx ?? 'ì¤‘ê°„';

  if (rawVolume < minVolume) continue;
  if (hasAdsOnly && adDepth <= 0) continue;

  keywordsToInsert.push({
    text,
    raw_volume: rawVolume,
    comp_idx: compIdx,
    comp_score: compIdxToScore(compIdx),
    ad_depth: adDepth,
    has_ads: adDepth > 0,
    est_cpc_krw: estCpc,
    est_cpc_source: 'searchads',
    score: calculateOverallScore(rawVolume, compIdxToScore(compIdx), adDepth, estCpc),
    source: 'bfs_seed'
  });
}
if (keywordsToInsert.length) await upsertMany(keywordsToInsert);

ì¤‘ìš”(ì •í•©ì„±/UX)

Job History ì¹´ìš´í„°ê°€ 0ìœ¼ë¡œë§Œ ë‚˜ì˜¬ ìˆ˜ ìˆìŒ
ì™„ë£Œ jobì˜ resultsê°€ êµ¬ í¬ë§·ì´ë©´ countersê°€ ì—†ì–´ ì „ë¶€ 0ìœ¼ë¡œ í‘œê¸°ë©ë‹ˆë‹¤.
ìˆ˜ì •: results.counters ì—†ì„ ë•Œ ìŠ¤í† ë¦¬ì§€ì—ì„œ ìµœì†Œì¹˜(ë°œê²¬ ë¸”ë¡œê·¸ ìˆ˜ ë“±)ë¥¼ ê³„ì‚°í•˜ê±°ë‚˜, ìœ„ â‘  íŒ¨ì¹˜ë¡œ /resultsì— ìƒˆ í¬ë§·ì„ ìºì‹œí•´ë‘ê³  ê·¸ê±¸ ì‚¬ìš©.

/api/serp/jobs/:jobId/cancelì´ pending ìƒíƒœ ì·¨ì†Œë¥¼ ë§‰ìŒ
ì‚¬ìš©ì ì·¨ì†Œê°€ ë°”ë¡œ ë¨¹íˆê²Œ pendingë„ í—ˆìš©í•˜ì„¸ìš”.

if (!['running','pending'].includes(job.status)) {
  return res.status(400).json({ error: "Job is not running or pending" });
}


GET /api/keywords ê¸°ë³¸ì´ ë¬´ì¡°ê±´ excluded=false
íŒŒë¼ë¯¸í„° ë¯¸ì§€ì • ì‹œ ì „ì²´ë¥¼ ë³´ë ¤ëŠ” ê²½ìš°ê°€ ë§ìŠµë‹ˆë‹¤.
ìˆ˜ì •: excludedê°€ ë¯¸ì§€ì •ì´ë©´ í•„í„°ë¥¼ ì „ë‹¬í•˜ì§€ ì•Šë„ë¡.

let excludedFilter: boolean | undefined = undefined;
if (excluded === 'true') excludedFilter = true;
else if (excluded === 'false') excludedFilter = false;

const keywords = await listKeywords({
  excluded: excludedFilter, // â† undefinedë©´ ì „ì²´
  orderBy: sort === 'text' ? 'text' : 'raw_volume',
  dir: order === 'asc' ? 'asc' : 'desc'
});


BFS seedsCsv íŒŒë¼ë¯¸í„°ê°€ ë¬´ì‹œë¨
ì§€ê¸ˆì€ í•­ìƒ loadSeedsFromCSV() ê¸°ë³¸ê²½ë¡œë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
ìˆ˜ì •: loadSeedsFromCSV(seedsCsv)ë¡œ ê²½ë¡œë¥¼ ë„˜ê¸°ê³ , í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜ë„ ë°›ë„ë¡.

// let seeds = loadSeedsFromCSV();
let seeds = loadSeedsFromCSV(seedsCsv); // â† ìš”ì²­ê°’ ë°˜ì˜


/api/keywords/refresh-allì´ ê³ ì • ë¬¸ìì—´ â€˜í™ì‚¼â€™ë§Œ ìˆ˜ì§‘
ì—”ë“œí¬ì¸íŠ¸ ì´ë¦„ê³¼ ë™ì‘ì´ ì–´ê¸‹ë‚©ë‹ˆë‹¤. base ë°°ì—´Â·ë¦¬ìŠ¤íŠ¸ë¥¼ ë°›ê±°ë‚˜ ë‚´ë¶€ í”„ë¦¬ì…‹ì„ ìˆœí™˜í•˜ë„ë¡ ê³ ì¹˜ì„¸ìš”(ë˜ëŠ” ë¼ìš°íŠ¸ëª…ì„ refresh-sampleë¡œ ë°”ê¾¸ê¸°).

CSV ì—…ë¡œë“œ MIME ì œí•œì´ ê³¼í˜‘ì†Œ
ë¸Œë¼ìš°ì €ê°€ CSVë¥¼ application/vnd.ms-excelë¡œ ë³´ë‚´ëŠ” ê²½ìš°ê°€ í”í•©ë‹ˆë‹¤.
ìˆ˜ì •:

if (['text/csv','application/vnd.ms-excel'].includes(file.mimetype) || file.originalname.toLowerCase().endsWith('.csv')) {
  cb(null, true);
} else {
  cb(new Error('Only CSV files are allowed'));
}


/api/keywords/export.csvì—ì„œ í¬ë®¬ëŸ¬ ì¸ì ì…˜ ë³´í˜¸ ë¶€ì¬
ë‹¤ë¥¸ CSV ìµìŠ¤í¬íŠ¸ëŠ” sanitizeCsvFieldë¥¼ ì“°ì§€ë§Œ, ì—¬ê¸°ì„  ìƒ í…ìŠ¤íŠ¸ë¥¼ ì”ë‹ˆë‹¤. ë™ì¼ ë³´í˜¸ ì ìš© ê¶Œì¥.

let csvOut = "text,raw_volume,volume,grade,excluded,updated_at\n";
for (const k of keywords) {
  const updatedAt = k.updated_at ? new Date(k.updated_at).toISOString() : '';
  csvOut += [
    sanitizeCsvField(k.text),
    sanitizeCsvField(k.raw_volume),
    sanitizeCsvField(k.volume),
    sanitizeCsvField(k.grade),
    sanitizeCsvField(k.excluded ? 'true' : 'false'),
    sanitizeCsvField(updatedAt)
  ].join(',') + '\n';
}
res.setHeader('Content-Type','text/csv; charset=utf-8');
res.setHeader('Content-Disposition','attachment; filename="keywords-export.csv"');
res.send('\ufeff' + csvOut);

ê²½ë¯¸(ì •ë¦¬/ì•ˆì „)

csv-parser ESM ë””í´íŠ¸ ì„í¬íŠ¸: esModuleInterop êº¼ì ¸ ìˆìœ¼ë©´ import * as csv from 'csv-parser'ë¡œ ë°”ê¾¸ì„¸ìš”.

ë¯¸ì‚¬ìš© ì„í¬íŠ¸: z, nlpService, checkAllServicesëŠ” ì œê±° ì¶”ì²œ(íŠ¸ë¦¬ ì…°ì´í‚¹, ê°€ë…ì„±).

duplicates ì¹´ìš´í„°: ì„ ì–¸ë§Œ ìˆê³  ì¦ê°€ ì•ˆ í•¨(ë‘ ê³³). í•„ìš” ì—†ìœ¼ë©´ ì‚­ì œ or ë¡œì§ ë³´ì™„.

ì·¨ì†Œ ì§í›„ ë ˆì´ìŠ¤: ì·¨ì†Œ í›„ì—ë„ ë£¨í”„ê°€ í•œ ë²ˆ ë” ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê° ë‚´ë¶€ ë£¨í”„(í‚¤ì›Œë“œÂ·ë¸”ë¡œê·¸Â·ë­í¬ ì²´í¬) ì‹œì‘ë¶€ì— ìˆëŠ” ì·¨ì†Œ ì²´í¬ëŠ” ì¢‹ì§€ë§Œ, â€œì €ì¥ ì§ì „â€ì—ë„ í•œ ì¤„ ë” ë„£ìœ¼ë©´ ì•ˆì „í•©ë‹ˆë‹¤.

/api/serp/analyzeÂ·/api/serp/search ì²˜ë¦¬ ë¶€í•˜: ë‹¨ì¼ í”„ë¡œì„¸ìŠ¤ì—ì„œ ì¥ê¸° ì‘ì—…ì´ë©´ ì´ë²¤íŠ¸ ë£¨í”„ ë¸”ë¡œí‚¹ ìœ„í—˜. ë‚˜ì¤‘ì— í/ì›Œì»¤(ì˜ˆ: BullMQ)ë¡œ ëº„ ê²ƒì„ ê¶Œì¥.

/api/keywords/:id: k.id íƒ€ì…ì´ ìˆ«ìì¸ ê²½ìš° ë¬¸ìì—´ ë¹„êµë¡œ ëª» ì°¾ì„ ìˆ˜ ìˆìœ¼ë‹ˆ í˜• ì¼ì¹˜ í™•ì¸.

ë¹ ë¥¸ ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸(ìš”ì²­/ì‘ë‹µ ì •ìƒ í™•ì¸)
# 1) ë¶„ì„ ì‹œì‘
curl -s -X POST http://localhost:3000/api/serp/analyze \
  -H 'Content-Type: application/json' \
  -d '{"keywords":["í™ì‚¼ìŠ¤í‹±","í™ì‚¼"],"minRank":2,"maxRank":15,"postsPerBlog":10}'

# 2) ìƒíƒœ
curl -s http://localhost:3000/api/serp/jobs/<jobId>

# 3) (ì„ íƒ) ëŒ€ê¸° ì¤‘ ì·¨ì†Œ í—ˆìš© í™•ì¸
curl -s -X POST http://localhost:3000/api/serp/jobs/<jobId>/cancel

# 4) ì™„ë£Œ í›„ ê²°ê³¼(ì‹ ê·œ í¬ë§·) â€” blogs/keywords/posts/counters í™•ì¸
curl -s http://localhost:3000/api/serp/jobs/<jobId>/results

# 5) í‚¤ì›Œë“œ ë¦¬ìŠ¤íŠ¸(ì „ì²´/ì œì™¸í•„í„°)
curl -s "http://localhost:3000/api/keywords?limit=20"
curl -s "http://localhost:3000/api/keywords?excluded=true&limit=20"