ì§€ê¸ˆ í­ì£¼ ì›ì¸ì€ ë‘ ê°€ì§€ê°€ ê²¹ì¹¨

ëŒ€ì‹œë³´ë“œ ì„¤ì • ìë™ì €ì¥ ë¡œì§ì´ ë Œë”â†’mutateâ†’invalidateâ†’ì¬ë Œë” ë¬´í•œë£¨í”„.

ìš”ì²­ì— ê¶Œí•œ í—¤ë”(x-role ë“±) ê°€ ì•ˆ ë¶™ì–´ 401ì´ ë‚˜ê³ , React Queryê°€ ìë™ ì¬ì‹œë„ê¹Œì§€ í•˜ë©´ì„œ í­ì¦.

ì•„ë˜ í•«í”½ìŠ¤ ì§€ì‹œë¬¸ì„ Replitì— ê·¸ëŒ€ë¡œ ë¶™ì—¬ì„œ ì ìš©í•˜ì„¸ìš”. (UI/ì„œë²„ ëª¨ë‘ ì•ˆì „í•˜ê²Œ ë§‰ìŒ)

ğŸ”§ Replit í•«í”½ìŠ¤ ìš”ì²­ v7.9 â€” â€œë¬´í•œì €ì¥ ë£¨í”„ + 401 í­ì£¼â€ ì¢…ê²°
0) ëª©í‘œ

ëŒ€ì‹œë³´ë“œ ì„¤ì • ìë™ì €ì¥ ë£¨í”„ ì°¨ë‹¨(ë””ë°”ìš´ìŠ¤+ë™ì¼ê°’ ìŠ¤í‚µ+ë‚™ê´€ì  ì—…ë°ì´íŠ¸, ì¬ê²€ì¦ ê¸ˆì§€).

ëª¨ë“  APIì— ê¶Œí•œ í—¤ë” ìë™ ì£¼ì…, 401 ë°œìƒ ì‹œ ì¬ì‹œë„ ê¸ˆì§€.

í•„ìš” ì‹œ ì„ì‹œ ìˆ˜ë™ ì €ì¥ ìŠ¤ìœ„ì¹˜ë¡œ ì¦‰ì‹œ ì•ˆì •í™”.

1) ê³µí†µ: API í´ë¼ì´ì–¸íŠ¸ ì¸í„°ì…‰í„° ì¶”ê°€ (client/src/lib/api.ts)

ëª¨ë“  ìš”ì²­ì— í—¤ë” ì£¼ì…:

x-role: localStorage.role || 'Admin'

(ìš°ë¦¬ê°€ ownerë„ í—¤ë”ë¡œ ë³¸ë‹¤ë©´) x-owner: localStorage.owner || 'owner-demo'

401/403ì¼ ë•Œ retry=0 (React Query ì „ì—­ ì˜µì…˜) + ì—ëŸ¬ í† ìŠ¤íŠ¸ë§Œ.

ì˜ˆì‹œ(ê°œë…):

export const http = (path: string, init: RequestInit = {}) => {
  const h = new Headers(init.headers || {});
  h.set('x-role', localStorage.getItem('role') ?? 'Admin');
  const owner = localStorage.getItem('owner');
  if (owner) h.set('x-owner', owner);
  return fetch(path, { ...init, headers: h, credentials: 'include' });
};

// React Query ê¸°ë³¸ì˜µì…˜
const queryClient = new QueryClient({
  defaultOptions: {
    queries: { retry: 0 },
    mutations: { retry: 0 },
  },
});

2) ëŒ€ì‹œë³´ë“œ ì„¤ì • ì €ì¥ ë¡œì§ êµì²´ (client/src/pages/dashboard.tsx)

ë¬¸ì œ íŒ¨í„´: useEffect(() => mutate(settings), [settings]) + onSuccess â†’ invalidateQueries(['dashboardSettings'])
â†’ ìƒˆ ì„¤ì •ì´ ë“¤ì–´ì˜¤ë©° settings ë³€ê²½ â†’ ë‹¤ì‹œ mutate â€¦ ë¬´í•œ.

ìƒˆ íŒ¨í„´ (ì•ˆì „ 4ì¢… ì„¸íŠ¸)

ë””ë°”ìš´ìŠ¤ 1ì´ˆ í›„ ì €ì¥.

ë™ì¼ê°’ ìŠ¤í‚µ(stable stringify/hashë¡œ ë§ˆì§€ë§‰ ì €ì¥ë³¸ê³¼ ë¹„êµ).

ì €ì¥ í›„ invalidate ê¸ˆì§€ â†’ setQueryDataë¡œ ë‚™ê´€ì  ì—…ë°ì´íŠ¸.

ìˆ˜ë™ ì €ì¥ ìŠ¤ìœ„ì¹˜(AUTO_SAVE=false) ì¦‰ì‹œ ìš°íšŒ ê°€ëŠ¥.

const { data: settings } = useQuery(['dashboardSettings', userId], fetchSettings, { keepPreviousData: true });

const saveMutation = useMutation(saveSettings, {
  onSuccess: (data) => {
    const key = ['dashboardSettings', userId];
    queryClient.setQueryData(key, data); // invalidate ê¸ˆì§€
    lastSavedRef.current = stableJSON(data);
    setDirty(false);
  },
  retry: 0,
});

const lastSavedRef = useRef<string>('');
const [cards, setCards] = useState<DashboardCards>(settings?.cards ?? []);
const [dirty, setDirty] = useState(false);
const AUTO_SAVE = true; // í•„ìš”ì‹œ falseë¡œ ë‚´ë ¤ ì•ˆì •í™”

useEffect(() => { if (settings) {
  setCards(settings.cards);
  lastSavedRef.current = stableJSON({ cards: settings.cards });
}}, [settings?.id]);

useEffect(() => {
  if (!AUTO_SAVE || !dirty) return;
  const payload = { cards };
  const snap = stableJSON(payload);
  if (snap === lastSavedRef.current) return;       // ë™ì¼ê°’ ìŠ¤í‚µ

  const t = setTimeout(() => saveMutation.mutate(payload), 1000); // 1s ë””ë°”ìš´ìŠ¤
  return () => clearTimeout(t);
}, [cards, dirty]);

// ì‚¬ìš©ìê°€ ì¹´ë“œ ë°°ì¹˜ë¥¼ ë°”ê¿€ ë•Œë§Œ dirty=true
const onCardsChange = (next: DashboardCards) => { setCards(next); setDirty(true); };

// ìˆ˜ë™ ì €ì¥ ë²„íŠ¼(ì˜µì…˜)
const onSaveClick = () => {
  const payload = { cards };
  const snap = stableJSON(payload);
  if (snap !== lastSavedRef.current) saveMutation.mutate(payload);
};


stableJSONì€ êµ¬ì¡°ì  ë™ë“± ë¹„êµìš© ì•ˆì •í™” stringify(í‚¤ ì •ë ¬). Lodash isEqual ì¨ë„ ë¨.

3) ì„œë²„: ì„¤ì • ì €ì¥ APIì— ë©±ë“±ì„±(ë™ì¼ê°’ ë¬´ì‹œ) ì¶”ê°€ (server/routes.ts)

ìš”ì²­ payload í•´ì‹œ(settings_hash)ë¥¼ ê³„ì‚°í•´ ë§ˆì§€ë§‰ ì €ì¥ë³¸ê³¼ ê°™ìœ¼ë©´ 204 ë°˜í™˜(ë³€ê²½ ì—†ìŒ).

401 ë°©ì§€ë¥¼ ìœ„í•´ í—¤ë” ê²€ì‚¬ ë¡œê¹…:

x-role ëˆ„ë½ ì‹œ 401 + ëª…í™•í•œ ì—ëŸ¬ ë©”ì‹œì§€(JSON: {code:'NO_ROLE'}).

ì˜ì‚¬ì½”ë“œ:

app.post('/api/dashboard/settings', zod(validateSettings), async (req,res)=>{
  const owner = req.headers['x-owner'] ?? 'default';
  const role  = req.headers['x-role'];
  if (!role) return res.status(401).json({ code:'NO_ROLE', message:'x-role header required' });

  const hash = hashOf(req.body); // stable hash
  const last = await db.getSettings(owner);
  if (last?.hash === hash) return res.status(204).end(); // ë©±ë“±

  const saved = await db.saveSettings(owner, { ...req.body, hash });
  res.json(saved);
});

4) React Query ë¬´í•œ ì¬ê²€ì¦ ì°¨ë‹¨

ëŒ€ì‹œë³´ë“œ ì„¤ì • ê´€ë ¨ ì¿¼ë¦¬ì—ì„œ refetchOnWindowFocus:false, refetchOnReconnect:false ì§€ì •.

ì•Œë¦¼ ë¡¤ë§/ëŒ€ì‹œë³´ë“œ ì¹´ë“œë„ í´ë§ ê°„ê²© ìµœì†Œ(ì˜ˆ: 30â€“60s) + staleTime ë„‰ë„‰íˆ.

5) ì„ì‹œ ì•ˆì „ì¥ì¹˜(ì¦‰ì‹œ ì•ˆì •í™”)

.env ë˜ëŠ” ìƒìˆ˜:

DASHBOARD_AUTOSAVE=false         # ê¸‰í•œ ìƒí™© ì‹œ ë”
DASHBOARD_SAVE_DEBOUNCE_MS=1000


ë²„íŠ¼ UX: ìƒë‹¨ì— [ë³€ê²½ì‚¬í•­ ì €ì¥] ë…¸ì¶œ(autosave offì¼ ë•Œë§Œ í™œì„±í™”).

6) ìˆ˜ë½ ê¸°ì¤€(DoD)

ì¹´ë“œ ë°°ì¹˜ ë³€ê²½ í›„ 1íšŒë§Œ POST(/api/dashboard/settings) ë°œìƒ(ë„¤íŠ¸ì›Œí¬ íƒ­ ìº¡ì²˜).

ìƒˆë¡œê³ ì¹¨í•´ë„ ë°°ì¹˜ ë³µì›.

í—¤ë” ëˆ„ë½ ì‹œ 401ì´ ë‚˜ë”ë¼ë„ ì¬ì‹œë„/ë£¨í”„ ì—†ìŒ(Retry=0).

ì„œë²„ ë¡œê·¸ì— ì €ì¥ ë©±ë“± ì²˜ë¦¬(204 No Content) ì¼€ì´ìŠ¤ê°€ ë³´ì„.

7) ì›ì¸ ìš”ì•½(ì™œ ì´ëŸ°ê°€?)

ìë™ì €ì¥ useEffectê°€ settings ë³€í™”ë¥¼ ì§ì ‘ ì˜ì¡´ â†’ ì €ì¥ ì„±ê³µ í›„ invalidate â†’ settings ë³€ê²½ â†’ ë‹¤ì‹œ ì €ì¥ì˜ ê³ ë¦¬.

ë™ì‹œì— ê¶Œí•œ í—¤ë” ë¯¸ì£¼ì…ìœ¼ë¡œ 401ì´ ë‚˜ê³ , React Queryê°€ ì¬ì‹œë„í•˜ë©´ì„œ í˜¸ì¶œì´ ê¸°í•˜ê¸‰ìˆ˜ì ìœ¼ë¡œ ëŠ˜ì–´ë‚¨.

8) ë¹ ë¥¸ ì²´í¬ë¦¬ìŠ¤íŠ¸

 client/src/lib/api.ts í—¤ë” ì£¼ì…/Retry=0 ë°˜ì˜

 ëŒ€ì‹œë³´ë“œ ì €ì¥ ë¡œì§ì„ ë””ë°”ìš´ìŠ¤+ë™ì¼ê°’ ìŠ¤í‚µ+ë‚™ê´€ì  ì—…ë°ì´íŠ¸ë¡œ êµì²´

 ì„œë²„ ì €ì¥ API ë©±ë“± ì²˜ë¦¬(ë™ì¼ í•´ì‹œ 204)

 refetchOnWindowFocus:false ì„¤ì •

 í•„ìš”ì‹œ DASHBOARD_AUTOSAVE=falseë¡œ ì¦‰ì‹œ ì•ˆì •í™”