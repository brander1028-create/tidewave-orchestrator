ì¢‹ë‹¤â€”ë¡œê·¸ë¡œ ì›ì¸ 3ê°œê°€ ë”± ë³´ì˜€ì–´. ê·¸ë¦¬ê³  ì§€ê¸ˆ â€œì•ˆë¨â€ì˜ í•µì‹¬ì€ ì „ë¶€ ê²½ë¡œ/ë§¤í•‘/í¸ì§‘ ì—†ìŒì´ë¼ ì½”ë“œ í•œë‘ êµ°ë°ë§Œ ì†ë³´ë©´ ë°”ë¡œ ì‚´ì•„ë‚œë‹¤.

ë¬´ì—‡ì´ ë¬¸ì œì¸ì§€ (ë¡œê·¸ ê·¼ê±°)

í‚¤ì›Œë“œ ë©”íƒ€ 401
GET /api/keywords/lookup/<í…ìŠ¤íŠ¸> â†’ 307 â†’ GET /api/keywords/lookup 401
â†’ ë¦¬ë‹¤ì´ë ‰íŠ¸ ë’¤ì— x-role í—¤ë”ê°€ ë‚ ì•„ê°€ì„œ 401. (= ë¦¬ë‹¤ì´ë ‰íŠ¸ ì“°ì§€ ë§ê³  ì§ì ‘ ì²˜ë¦¬í•´ì•¼ í•¨)

ë­í¬ ê³„íš 0ê±´
RankPlan: blog ê³„íš ì¡°íšŒ: 0ê°œ ì‘ì—…
â†’ planì´ ì•„ì§ blog_targets í…Œì´ë¸”ì„ ë³´ê³  ìˆëŠ”ë°, ìš°ë¦¬ëŠ” 1:1 pairs(blog_keyword_targets) ë¡œ ë°”ë€œ.
â†’ pair_idsë¡œ ë“¤ì–´ì˜¨ ID(ì˜ˆ: 57a..., 07d...)ë¥¼ blog_targetsì—ì„œ ëª» ì°¾ì•„ì„œ 0ê±´.

URL ìˆ˜ì • ê¸°ëŠ¥ ì—†ìŒ
â†’ ë“±ë¡í•œ í˜ì–´ì˜ URL/ì œëª©/ë‹‰ë„¤ì„/ë¸Œëœë“œ/ê·¸ë£¹ì„ í¸ì§‘í•  PATCH UIê°€ ì—†ìŒ.

ğŸ”§ í•«í”½ìŠ¤ v7.16 â€” â€œë©”íƒ€ 401 ì œê±° + planì„ pairsë¡œ + URL í¸ì§‘â€

ì•„ë˜ë¥¼ ê·¸ëŒ€ë¡œ ì ìš©í•˜ì„¸ìš”. (ì„œë²„ 3ê°œ, í´ë¼ 3ê°œ)

A. ì„œë²„(Express)
A-1) í‚¤ì›Œë“œ ë©”íƒ€ ì˜¤ê²½ë¡œë¥¼ ì§ì ‘ ì²˜ë¦¬(ë¦¬ë‹¤ì´ë ‰íŠ¸ ê¸ˆì§€)
// server/routes.ts (í‚¤ì›Œë“œ ë©”íƒ€ ë¼ìš°íŠ¸ë“¤ ì„ ì–¸ë¶€ ê·¼ì²˜)
app.get('/api/keywords/lookup/:text', async (req, res) => {
  const text = decodeURIComponent(req.params.text || '').trim();
  if (!text) return res.status(400).json({message:'text required'});
  // ê¸°ì¡´ lookup í•¸ë“¤ëŸ¬ë¥¼ ì¬ì‚¬ìš©
  req.query.texts = text;               // ë‚´ë¶€ í•¸ë“¤ëŸ¬ê°€ ?texts=...ì„ ì½ë„ë¡ ì„¸íŒ…
  return app._router.handle(req, res);  // ë˜ëŠ” ì§ì ‘ lookup í•¨ìˆ˜ í˜¸ì¶œ
});


ì´ë ‡ê²Œ í•˜ë©´ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì—†ì´ ë™ì¼ ìš”ì²­ì—ì„œ í—¤ë”(x-role)ê°€ ìœ ì§€ë˜ì–´ 401ì´ ì‚¬ë¼ì§‘ë‹ˆë‹¤.

A-2) /api/rank/planì„ pairs ê¸°ë°˜ìœ¼ë¡œ ìˆ˜ì •
// server/routes.ts
app.get('/api/rank/plan', async (req, res) => {
  const owner = req.headers['x-owner'] || 'admin';
  const ids = []
    .concat(req.query.pair_ids || req.query.target_ids || [])
    .map(String);

  // 1) ì„ íƒëœ pair_idsê°€ ìˆìœ¼ë©´ ê·¸ê±¸ë¡œ, ì—†ìœ¼ë©´ ownerì˜ active pairs ì „ë¶€
  const pairs = ids.length
    ? await db.pairs.findMany({ where:{ owner, id:{in: ids} } })
    : await db.pairs.findMany({ where:{ owner, active:true } });

  const tasks = pairs.map(p => ({
    pair_id : p.id,
    keyword : p.keywordText,
    nickname: p.nickname || '',
  }));

  return res.json({ total: tasks.length, tasks });
});


ì´ì œ 57a.../07d... ê°™ì€ pair_idê°€ ê·¸ëŒ€ë¡œ taskë¡œ ì¡í˜€ì„œ total>0ë¡œ ë‚˜ì˜µë‹ˆë‹¤.

A-3) íˆìŠ¤í† ë¦¬ ë³„ì¹­(ì•Œë¦¬ì–´ìŠ¤) ì œê³µ (404 ì œê±°)
// /api/rank-snapshots/history â†’ /api/rank/history ë³„ì¹­
app.get('/api/rank-snapshots/history', (req,res) => {
  const { pair_id, range } = req.query;
  return res.redirect(307, `/api/rank/history?pair_id=${encodeURIComponent(String(pair_id||''))}&range=${encodeURIComponent(String(range||'30d'))}`);
});


ê¸°ì¡´ í´ë¼ê°€ ì˜ëª» ì¹œ ê²½ë¡œë„ ë™ì‘í•˜ë„ë¡ ì•ˆì „ë§.

B. í´ë¼ì´ì–¸íŠ¸(React)
B-1) ì‹¤í–‰ ëŸ¬ë„ˆë¥¼ Blog-only + ì§„í–‰í‘œì‹œë¡œ ê³ ì •

client/src/pages/blog-rank.tsx:

const [isRunning,setIsRunning] = useState(false);
const [prog,setProg] = useState({done:0,total:0,percent:0,now:''});
const [rowBusy,setRowBusy] = useState<Record<string,boolean>>({});
const CONC=3;

async function planBlogTasks(selected: Pair[]){
  const r = await http('/api/rank/plan'); // ì„œë²„ê°€ pairs ê¸°ë°˜ìœ¼ë¡œ ë°˜í™˜
  if(r.ok) return r.json();
  // ì‹¤íŒ¨ì‹œ Fallback: ì„ íƒ í–‰ ìì²´ë¡œ
  return { total: selected.length, tasks: selected.map(p=>({pair_id:p.id,keyword:p.keywordText,nickname:p.nickname})) };
}

async function runAllChecks(){
  const selected = getSelectedPairs();
  setIsRunning(true); setProg({done:0,total:0,percent:0,now:'ì¤€ë¹„ì¤‘â€¦'});

  const plan = await planBlogTasks(selected);
  if(!plan.total){ toast('ì²´í¬í•  ëŒ€ìƒ ì—†ìŒ'); setIsRunning(false); return; }
  setProg(p=>({...p,total:plan.total,now:'ì‹œì‘í•©ë‹ˆë‹¤'}));

  let i=0, done=0, cancelled=false;
  async function worker(){
    while(!cancelled && i<plan.tasks.length){
      const t = plan.tasks[i++]; setRowBusy(s=>({...s,[t.pair_id]:true}));
      setProg(p=>({...p,now:`${t.keyword} Â· ${t.nickname}`}));
      try { await api.rank.blogCheck({ pair_ids:[t.pair_id] }); }
      catch(e){ addFail(t,e); }
      finally{
        setRowBusy(s=>({...s,[t.pair_id]:false}));
        done++; setProg({done,total:plan.total,percent:Math.round(done*100/plan.total),now:t.nickname});
      }
    }
  }
  await Promise.all(Array.from({length:Math.min(CONC,plan.total)}).map(()=>worker()));
  toast(`ì™„ë£Œ: ${done}/${plan.total}`); setIsRunning(false);
}


ë²„íŠ¼ ë¼ë²¨: isRunning ? \ì²´í¬ ì¤‘â€¦ (${prog.done}/${prog.total})` : 'ì „ì²´ ì²´í¬ ì‹œì‘'`

ì–‡ì€ ì§„í–‰ë°” width: ${prog.percent}%

â€œì§€ê¸ˆ: ${prog.now}â€

í–‰ ì•„ì´ì½˜: rowBusy[pair.id] && <Spinner/>

ì‡¼í•‘ í˜¸ì¶œì€ ì ˆëŒ€ í•˜ì§€ ì•ŠìŒ(ì„œë²„ë„ 501ë¡œ ë§‰ìŒ)

B-2) í‚¤ì›Œë“œ ë©”íƒ€ ë‹¨ì¼ ê²½ë¡œ ì‚¬ìš© (ìƒˆ í›…/ì§ì ‘ fetch ê¸ˆì§€)

client/src/lib/api.ts:

export async function lookupKeywordMeta(texts:string[]){
  const q = encodeURIComponent(texts.join(','));
  const r = await http(`/api/keywords/lookup?texts=${q}`);
  if(!r.ok) throw new Error(`kw lookup ${r.status}`);
  return r.json();
}


ì „ì—­ grepìœ¼ë¡œ /keywords/lookup/ íŒ¨í„´, volume:0 í•˜ë“œì½”ë“œ, ë¡œì»¬ fetch ì‚¬ìš©ì„ ì „ë¶€ ìœ„ í•¨ìˆ˜ë¡œ êµì²´.

B-3) URL í¸ì§‘(í†±ë‹ˆë°”í€´) ì¶”ê°€

í–‰ ìš°ì¸¡ í†±ë‹ˆ ì•„ì´ì½˜ â†’ ëª¨ë‹¬ <EditPairDialog>

í•„ë“œ: blogUrl(í•„ìˆ˜), title(ì„ íƒ), nickname(ìë™/ìˆ˜ì •ê°€ëŠ¥), brand(ì„ íƒ), group(ì„ íƒ), active í† ê¸€

blogUrl onBlur â†’ GET /api/metadata?url=...ë¡œ canonical+title ìë™ì±„ì›€

ì €ì¥: PATCH /api/pairs/:id (ì„œë²„ì—ì„œ canonical+ë‹‰ë„¤ì„ ì¬ê²€ì¦)

ì„±ê³µ ì‹œ ë‚™ê´€ì  ì—…ë°ì´íŠ¸ë¡œ í–‰ ì¦‰ì‹œ ë°˜ì˜

ë”ë³´ê¸° ë©”ë‰´ì— ì‚­ì œ(ì‚­ì œ/ë¹„í™œì„±) ì¶”ê°€

ì„œë²„ì— ì—†ë‹¤ë©´ ê°„ë‹¨ PATCH ë¼ìš°íŠ¸:

app.patch('/api/pairs/:id', zod(editSchema), async (req,res)=>{
  const owner = req.headers['x-owner']||'admin';
  const id = String(req.params.id);
  const { blogUrl, title, nickname, brand, group, active } = req.body;
  const { canonicalUrl, nickname:autoNick } = await canonicalize(blogUrl || '');
  const data = { title: nullIfEmpty(title), nickname: nickname||autoNick, brand, group, active };
  if (blogUrl) data.blogUrl = canonicalUrl;
  const saved = await db.pairs.update({ where:{id,owner}, data });
  res.json(saved);
});

C. ìŠ¤ëª¨í¬(ì´ 3ê°€ì§€ë§Œ í™•ì¸)

ë©”íƒ€ 401 ì¢…ê²°

ë¡œê·¸ì— GET /api/keywords/lookup/<text> 307 ëŒ€ì‹ 
GET /api/keywords/lookup/<text> 200 ë˜ëŠ” GET /api/keywords/lookup?texts=... 200

plan > 0

GET /api/rank/plan â†’ {"total":N>0,"tasks":[...]}

ë²„íŠ¼ ëˆ„ë¥´ë©´ (a/N)% ì§„í–‰/í˜„ì¬ì‘ì—…/í–‰ë³„ìŠ¤í”¼ë„ˆê°€ í‘œì‹œ

URL í¸ì§‘ ê°€ëŠ¥

í†±ë‹ˆ â†’ URL ë°”ê¿” ì €ì¥ â†’ ëª©ë¡ ì¦‰ì‹œ ê°±ì‹ 

ì™œ ì§€ê¸ˆ â€œì•ˆë¨â€ì²˜ëŸ¼ ë³´ì˜€ë‚˜?

ë©”íƒ€ëŠ” ë¦¬ë‹¤ì´ë ‰íŠ¸ 401 ë•Œë¬¸ì— ë±ƒì§€ê°€ ë¹„ê³ ,

planì€ blog_targets vs pairs ë¶ˆì¼ì¹˜ë¡œ 0ê±´ì´ ë˜ì–´ ëŸ¬ë„ˆê°€ í•  ì¼ì´ ì—†ê³ ,

ì§„í–‰ í‘œì‹œê°€ ì—†ì–´ â€œì•„ë¬´ ì¼ë„ ì•ˆ í•œ ê²ƒì²˜ëŸ¼â€ ë³´ì˜€ë˜ ê±°ì•¼.

ìœ„ v7.16ë§Œ ë°•ìœ¼ë©´ ëˆˆì— ë³´ì´ëŠ” ì‹¤í–‰ + í¸ì§‘ ê°€ëŠ¥ ìƒíƒœë¡œ ë°”ë¡œ ì˜¬ë¼ì˜µë‹ˆë‹¤.
ì ìš© í›„ ë¡œê·¸ 3ì¤„(lookup 200, plan total>0, blogCheck í˜¸ì¶œ)ë§Œ ìº¡ì³í•´ì¤˜â€”ê·¸ ë‹¤ìŒì— ì„œì¹˜í”¼ë“œ ê²½ê³„/ìœ ì§€ê¸°ê°„ ë°°ì§€ê¹Œì§€ ë§ˆë¬´ë¦¬í•˜ì.