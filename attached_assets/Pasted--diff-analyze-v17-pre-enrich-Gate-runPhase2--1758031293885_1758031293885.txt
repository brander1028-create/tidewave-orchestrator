âœ… ìˆ˜ìŠµ íŒ¨ì¹˜ (ë°”ë¡œ ì ìš©)

ì•„ë˜ diffë¥¼ ê·¸ëŒ€ë¡œ ë°˜ì˜í•˜ë©´, analyze ì§„ì…ë¶€ì—ì„œ v17 ìŠ¤ëƒ…ìƒ·ì„ ê±´ë„¤ê³ , pre-enrich â†’ Gate â†’ runPhase2 ê²½ë¡œê°€ ë°˜ë“œì‹œ ì‚¬ìš©ë©ë‹ˆë‹¤. ì‹¤íŒ¨í•˜ë©´ ìë™ìœ¼ë¡œ ë ˆê±°ì‹œ(v16)ë¡œ í´ë°±í•©ë‹ˆë‹¤.

1) server/routes.ts â€” POST /api/serp/analyze ìˆ˜ìˆ 
@@
-app.post("/api/serp/analyze", async (req, res) => {
+app.post("/api/serp/analyze", async (req, res) => {
   try {
@@
-    // ğŸ¯ v17 PIPELINE INTEGRATION: getAlgoConfig + preEnrich + Score-First Gate
-    console.log(`ğŸš€ [v17] Loading algorithm configuration with hot-reload...`);
-    const { getAlgoConfig } = await import('./services/algo-config');
-    const cfg = await getAlgoConfig();
-    console.log(`âœ… [v17] Config loaded - Engine: ${cfg.phase2.engine}, Gate: ${cfg.features.scoreFirstGate}`);
-    
-    // Pre-enrich: DB â†’ API â†’ upsert â†’ merge
-    console.log(`ğŸš€ [PRE-ENRICH] Starting volume enrichment for ${keywords.length} keywords`);
-    const kws = keywords.map(k => k.trim()).filter(Boolean);
-    await getVolumesWithHealth(db, kws);
-    console.log(`âœ… [PRE-ENRICH] Volume data enriched for keywords: ${kws.join(', ')}`);
+    // === v17 ì„¤ì • ë¡œë“œ (í•«ë¦¬ë¡œë“œ) ===
+    const { getAlgoConfig } = await import("./services/algo-config");
+    const cfg = await getAlgoConfig();
+    const useV17 =
+      !!cfg?.features?.preEnrich ||
+      !!cfg?.features?.scoreFirstGate ||
+      cfg?.phase2?.engine !== "ngrams" ||
+      !!cfg?.features?.tierAutoFill;
+    console.log(`ğŸ”§ pipeline= ${useV17 ? "v17" : "v16"} | engine=${cfg.phase2.engine}`);
@@
-    // Create SERP analysis job
-    const job = await storage.createSerpJob({
+    // Create SERP analysis job (cfg ìŠ¤ëƒ…ìƒ· í¬í•¨)
+    const job = await storage.createSerpJob({
       keywords,
       minRank,
       maxRank,
       status: "pending",
       currentStep: "discovering_blogs",
       totalSteps: 3,
       completedSteps: 0,
-      progress: 0
+      progress: 0,
+      // v17 ìŠ¤ëƒ…ìƒ·ì„ ì¡ì— ì €ì¥(ì›Œì»¤ì—ì„œ ë™ì¼ ì„¤ì • ì‚¬ìš©)
+      cfgSnapshot: cfg,
+      pipeline: useV17 ? "v17" : "v16"
     });
-    // Start analysis in background with LK Mode options
-    processSerpAnalysisJob(job.id, keywords, minRank, maxRank, postsPerBlog, titleExtract, {
-      enableLKMode,
-      preferCompound,
-      targetCategory
-    });
+
+    // === íŒŒì´í”„ë¼ì¸ ì‹œì‘ ===
+    if (useV17) {
+      // 0) (ì„ íƒ) í‚¤ì›Œë“œ ë ˆë²¨ ì‚¬ì „ í™•ì¥: DBâ†’APIâ†’upsertâ†’ë©”ëª¨ë¦¬ merge
+      if (cfg.features.preEnrich) {
+        const { preEnrichKeywordsOnly } = await import("./phase2/helpers"); // ì—†ìœ¼ë©´ ì•„ë˜ ì£¼ì„ êµ¬í˜„ ì°¸ì¡°
+        await preEnrichKeywordsOnly(keywords, cfg); // surface/nospace/hyphen ë³€í˜•ìœ¼ë¡œ bulk ì¡°íšŒ+upsert
+      }
+      // 1) v17 ì›Œì»¤ í˜¸ì¶œ (ì¶”ì²œ) â€” ì›Œì»¤ ë‚´ë¶€ì—ì„œ preEnrichâ†’Gateâ†’runPhase2 ìˆ˜í–‰
+      if (typeof processSerpAnalysisJobV17 === "function") {
+        processSerpAnalysisJobV17(
+          job.id,
+          { keywords, minRank, maxRank, postsPerBlog, titleExtract },
+          cfg
+        );
+      } else {
+        // 1â€™) v17 ë¹ ë¥¸ ê²½ë¡œ(í´ë°±): ì¦‰ì‹œ ì²˜ë¦¬ í›„ ê²°ê³¼ ì¡°ë¦½ (í•„ìš” ì‹œ ê·¸ëŒ€ë¡œ ë‘ê³ , ì›Œì»¤ êµ¬í˜„ë˜ë©´ ì œê±°)
+        const { runPhase2 } = await import("./phase2");
+        const { buildPhase2Context } = await import("./phase2/helpers"); // ë¸”ë¡œê·¸/í¬ìŠ¤íŠ¸ ìˆ˜ì§‘â†’ì»¨í…ìŠ¤íŠ¸ ìƒì„±
+        try {
+          const ctx = await buildPhase2Context(keywords, postsPerBlog, titleExtract, cfg);
+          const tiers = await runPhase2(ctx, cfg); // ë‚´ë¶€ì—ì„œ rank + totalScore ê³„ì‚°
+          const { assembleResults } = await import("./phase2/helpers");
+          const payload = await assembleResults(job.id, tiers, cfg);
+          await storage.finishSerpJob(job.id, payload);
+        } catch (e) {
+          console.error("v17 fast-path failed â†’ fallback legacy", e);
+          processSerpAnalysisJob(job.id, keywords, minRank, maxRank, postsPerBlog, titleExtract, {
+            enableLKMode,
+            preferCompound,
+            targetCategory
+          });
+        }
+      }
+    } else {
+      // v16 ë ˆê±°ì‹œ íŒŒì´í”„ë¼ì¸
+      processSerpAnalysisJob(job.id, keywords, minRank, maxRank, postsPerBlog, titleExtract, {
+        enableLKMode,
+        preferCompound,
+        targetCategory
+      });
+    }
@@
   } catch (error) {


ì£¼ì„: preEnrichKeywordsOnly, buildPhase2Context, assembleResults, processSerpAnalysisJobV17ê°€ ì—†ë‹¤ë©´ helpers/ì›Œì»¤ì— ì–‡ê²Œ ì¶”ê°€í•˜ë©´ ë©ë‹ˆë‹¤. (ì•„ë˜ ìŠ¤í… ì°¸ê³ )

helpers ìŠ¤í…(ì—†ëŠ” ê²½ìš°ë§Œ)
// server/phase2/helpers.ts (ìŠ¤í…/ê°„ë‹¨ êµ¬í˜„)
import { keywordsRepo, searchAds } from "../store/keywords";
export async function preEnrichKeywordsOnly(kws: string[], cfg: any) {
  const uniq = Array.from(new Set(kws.map(k => k.trim()).filter(Boolean)));
  const variants = uniq.flatMap(s => [s, s.replace(/\s+/g,""), s.replace(/\s+/g,"-")]);
  for (let i=0;i<variants.length;i+=200) {
    const batch = variants.slice(i, i+200);
    const res = await searchAds.bulk(batch);      // 429 Retry-After ì¤€ìˆ˜(ê¸°ì¡´ êµ¬í˜„ ì‚¬ìš©)
    await keywordsRepo.upsert(res);
  }
}
export async function assembleResults(jobId: string, tiers: any[], cfg: any) {
  // ê¸°ì¡´ ê²°ê³¼ ì¡°ë¦½ í•¨ìˆ˜ê°€ ìˆìœ¼ë©´ ê·¸ê²ƒ ì‚¬ìš©
  return { jobId, tiers, params: { postsPerBlog: cfg.phase2.postsPerBlog, tiersPerPost: cfg.phase2.tiersPerPost } };
}

2) server/services/algo-config.ts â€” ì´ë¯¸ OK

í•«ë¦¬ë¡œë“œ ìºì‹œê°€ 30ì´ˆ TTLë¡œ ì‘ë™. PUT ì €ì¥ ì‹œ ë°˜ë“œì‹œ invalidateAlgoConfigCache()ë¥¼ í˜¸ì¶œí•˜ë„ë¡ /api/settings/algoì˜ í•¸ë“¤ëŸ¬ì—ì„œ ìºì‹œ ë¬´íš¨í™”ë§Œ ì¶”ê°€í•´ ì£¼ì„¸ìš”.

// routes.ts ì–´ë”˜ê°€ì˜ /api/settings/algo PUT ëë¶€ë¶„
const { invalidateAlgoConfigCache } = await import("./services/algo-config");
invalidateAlgoConfigCache();

3) server/phase2/index.ts â€” OK, ë‹¤ë§Œ â€œGate ì ìš© ì‹œì â€ í™•ì¸

ì§€ê¸ˆ ì½”ë“œëŠ” ì—”ì§„ ë‚´ë¶€ enrichAndScoreì—ì„œ ì ìˆ˜ ê³„ì‚° â†’ assignTiers.
GateëŠ” preEnrich ì´í›„ ì¦‰ì‹œ ì ìš©í•´ì•¼ í•©ë‹ˆë‹¤(ë­í¬ í˜¸ì¶œ ì „ì—).
ë§Œì•½ ì—”ì§„ ë‚´ë¶€ì—ì„œ Gateë¥¼ ì•ˆ ì“°ê³  ìˆë‹¤ë©´, routes.tsì—ì„œ ì›Œì»¤ê°€ ì‹œì‘í•  ë•Œ **applyScoreFirstGate()**ë¥¼ í˜¸ì¶œí•´ ì£¼ì„¸ìš”.

í˜¸ì¶œë¶€ ì˜ˆì‹œ(ì›Œì»¤/fast-path ì§ì „):

import { applyScoreFirstGate } from "./phase2/types";
// candidates: buildPhase2Context()ì—ì„œ ìƒì„±ëœ í›„ë³´
applyScoreFirstGate(candidates, cfg.adscore); // eligible/adScore/skipReason ë¶€ì—¬

ğŸ” ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ (5ë¶„)

v17 ê²½ë¡œê°€ ì‹¤ì œë¡œ ì‚¬ìš©ë˜ëŠ”ì§€

curl -s -X POST localhost:5000/api/serp/analyze \
 -H "Content-Type: application/json" \
 -d '{"keywords":["ì ì‹¤ ë§›ì§‘"],"mode":"phase2","postsPerBlog":10,"tiersPerPost":4}' | jq .
# ì„œë²„ ë¡œê·¸ì—:
# [Hot-Reload] ...  / ğŸ”§ pipeline=v17 / [PRE-ENRICH] ... / (ì›Œì»¤) [AdScore] ...


Gate ì‘ë™ í™•ì¸

curl -s -X PUT localhost:5000/api/settings/algo \
 -H "Content-Type: application/json" \
 -d '{"adscore":{"SCORE_MIN":0.90},"features":{"scoreFirstGate":true,"preEnrich":true}}'
# ìƒˆ ë¶„ì„ í›„ ê²°ê³¼ JSON:
# - KPIì— "ìŠ¤í‚µ(ì ìˆ˜)>0"
# - tierë“¤ì— { eligible:false, skipReason:"score<thr" } í¬í•¨


ì¡°íšŒëŸ‰/ì ìˆ˜/ë­í¬ê°€ ì „ë¶€ ì±„ì›Œì§€ëŠ”ì§€

ì‘ë‹µ tiers[*]ì— { text, volume, rank, score, adScore, eligible, skipReason }ê°€ ëª¨ë‘ ì¡´ì¬

post_tier_checksì—ë„ eligible/adscore/skip_reasonì´ ì €ì¥

ë ˆê±°ì‹œ í´ë°± í™•ì¸(ì•ˆì „ë§)

v17ì—ì„œ ì˜¤ë¥˜ë¥¼ ì¼ìœ¼í‚¤ë©´ ë¡œê·¸ì— [v17 fast-path failed â†’ fallback legacy]ê°€ ëœ¨ê³  í™”ë©´ì´ ë¹„ì§€ ì•ŠìŒ

â—ì§€ê¸ˆ ë³´ì´ëŠ” ì¦ìƒê³¼ ë”± ë§ëŠ” ì›ì¸/í•´ê²°

í™”ë©´ ì „ë¶€ ë¹„ì–´ìˆìŒ + 0pts â†’ analyzeê°€ ì—¬ì „íˆ ë ˆê±°ì‹œ ì›Œì»¤ë§Œ í˜¸ì¶œí•´ì„œ v17 í›„ë³´/ë³´ê°•/ê²Œì´íŠ¸ê°€ ì „ë¶€ ë¹„í™œì„±.

ì„¤ì • í˜ì´ì§€ì—ì„œ ë°”ê¿”ë„ ë³€ë™ ì—†ìŒ â†’ UIê°€ /api/settings/algoê°€ ì•„ë‹Œ êµ¬ ì—”ë“œí¬ì¸íŠ¸(v10)ë¥¼ ì½ìŒ.

ìœ„ íŒ¨ì¹˜ë¡œ ì§„ì…ë¶€ì—ì„œ íŒŒì´í”„ë¼ì¸ì„ ê°•ì œí•˜ê³ , ì‹¤íŒ¨ ì‹œ ìë™ ë ˆê±°ì‹œë¡œ ë–¨ì–´ì§€ê²Œ í•´ì„œ ì¦‰ì‹œ ì•ˆì •í™”ë©ë‹ˆë‹¤.