ê²°ë¡ ë¶€í„°: API ë°´ë³´ë‹¤ëŠ” â€œì‹œë“œê°€ 0ê°œë¡œ ë“¤ì–´ê°€ì„œ BFSê°€ ê³§ë°”ë¡œ ì¢…ë£Œ(done)â€ ì¼€ì´ìŠ¤ê°€ ê°€ì¥ ìœ ë ¥í•©ë‹ˆë‹¤.
í™”ë©´ë„ í: 0 / ë°©ë¬¸: 0, ì§„í–‰ë¥  0% â†’ í”„ë¡ í‹°ì–´ê°€ ë¹„ì–´ ì‹œì‘=ì¦‰ì‹œ done íŒ¨í„´ê³¼ ì¼ì¹˜í•´ìš”. ì§€ê¸ˆ crawl ë¼ìš°íŠ¸ê°€ ì—…ë¡œë“œ ì‹œë“œ(fileId) ë¥¼ ëª» ì½ê³ , ë‚´ë¶€ CSVë„ ê²½ë¡œ ì—†ì´ loadSeedsFromCSV()ë¥¼ ë¶ˆëŸ¬ ë¹ˆ ë°°ì—´ì„ ë°›ì„ ê°€ëŠ¥ì„±ì´ í½ë‹ˆë‹¤. ê·¸ë˜ì„œ â€œëœë‹¤ê³ â€ ëœ¨ëŠ”ë° 0 ìˆ˜ì§‘ì´ì—ìš”.

ì•„ë˜ ìµœì†Œ íŒ¨ì¹˜ë¡œ ë°”ë¡œ ì‚´ì•„ë‚˜ê²Œ í•˜ì„¸ìš”.

1) ì›ì¸ ìš”ì•½ (ì§€ê¸ˆ ì½”ë“œ ê¸°ì¤€)

/api/keywords/crawlì—ì„œ ì‹œë“œ ê²°ì • ë¡œì§:

if (userSeeds && userSeeds.length > 0) {
  seeds = userSeeds;
} else {
  seeds = loadSeedsFromCSV(); // â† ê²½ë¡œ ì¸ì ì—†ìŒ â†’ ë¹ˆ ë°°ì—´ ê°€ëŠ¥ì„± í¼
}


âœ ì—…ë¡œë“œ fileIdë¥¼ ì½ëŠ” ë¶„ê¸° ìì²´ê°€ ì—†ìŒ. CSVë„ ê²½ë¡œ ë¯¸ì „ë‹¬.

ê·¸ë˜ì„œ crawler.initializeWithSeeds(seeds)ê°€ ë¹ˆ seedsë¡œ í˜¸ì¶œ â†’ í”„ë¡ í‹°ì–´ 0 â†’ done(0/20000).

â€œNo volume data â€¦ skippingâ€ ë¡œê·¸ëŠ” expand ìª½ì—ì„œ ì¼ë¶€ ë‚˜ì˜¤ëŠ” ê²ƒì´ê³ , BFSëŠ” ì•„ì˜ˆ ì‹œì‘ ì „ ì¢…ë£Œê°€ ë¬¸ì œì˜ í•µì‹¬.

2) ë”± ë‘ êµ°ë°ë§Œ ê³ ì¹˜ë©´ í•´ê²°
A) ì—…ë¡œë“œ ì§€ì› + fileId ì‹œë“œ ë¡œë”©
// â‘  ì—…ë¡œë“œ ì—”ë“œí¬ì¸íŠ¸ (CSV/XLSX â†’ fileId)
// ì´ë¯¸ ìˆë‹¤ê³  í–ˆì§€ë§Œ ì—†ë‹¤ë©´ ì¶”ê°€
app.post('/api/uploads', upload.single('file'), async (req, res) => {
  if (!req.file) return res.status(400).json({ error: 'No file uploaded' });
  const rows:any[] = [];
  await new Promise<void>((resolve, reject) => {
    Readable.from(req.file!.buffer).pipe(csv())
      .on('data', d => rows.push(d))
      .on('end', resolve).on('error', reject);
  });
  const seeds = rows.map(r => (r.seed || r.SEED || r['Seed'] || '').toString().trim()).filter(Boolean);
  if (!seeds.length) return res.status(400).json({ error: 'No seeds in CSV' });

  const fileId = 'upload-' + Date.now();
  await metaSet(db, fileId, { seeds, at: Date.now() }); // ë©”íƒ€ì— ì €ì¥
  res.json({ fileId, rows: seeds.length });
});

// â‘¡ /api/keywords/crawl ì‹œë“œ ê²°ì •ë¶€ ìˆ˜ì •
app.post('/api/keywords/crawl', async (req, res) => {
  // ...
  const {
    source='builtin',             // 'manual'|'file'|'builtin'
    seeds: userSeeds = [],
    seedsFileId,
    seedsCsv = '/mnt/data/seed_keywords_v2_ko.csv',
    // ...
  } = req.body || {};

  let seeds:string[] = [];
  if (source === 'manual' && userSeeds.length) {
    seeds = userSeeds;
    console.log(`ğŸŒ± manual seeds: ${seeds.length}`);
  } else if (source === 'file' && seedsFileId) {
    const up = await metaGet<any>(db, seedsFileId);
    if (!up?.seeds?.length) return res.status(400).json({ error:'Invalid seedsFileId or empty seeds' });
    seeds = up.seeds;
    console.log(`ğŸŒ± file seeds: ${seeds.length}`);
  } else {
    // builtin CSV ëª…ì‹œì  ê²½ë¡œ í•„ìš”
    seeds = loadSeedsFromCSV(seedsCsv);   // â† í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜ path ë°›ë„ë¡
    if (!seeds.length) return res.status(400).json({ error:`No seeds in CSV: ${seedsCsv}` });
    console.log(`ğŸŒ± builtin seeds: ${seeds.length}`);
  }

  // ë¹ˆ í”„ë¡ í‹°ì–´ ê°€ë“œ: ì”¨ë“œ ì—†ìœ¼ë©´ ê³§ë°”ë¡œ done ë°©ì§€
  if (!Array.isArray(seeds) || seeds.length === 0) {
    return res.status(400).json({ error: 'No seeds to start BFS' });
  }

  // ... ë‚˜ë¨¸ì§€ ë™ì¼ (initializeWithSeeds â†’ crawl)
});


í•„ìˆ˜: loadSeedsFromCSV(path?:string)ë¡œ ë°”ê¿” /mnt/data/seed_keywords_v2_ko.csvë¥¼ ì½ë„ë¡ í•´ì£¼ì„¸ìš”.

3) ì§„í–‰ë¥ /ì¹´ìš´í„°ëŠ” â€œí•­ìƒ ì¦ê°€â€í•˜ê²Œ

í¬ë¡¤ ì‹œì‘ ì§í›„ ì´ˆê¸° ì§„í–‰ê°’ì— frontierSizeë¥¼ ì‹¤ì–´ ë³´ë‚´ê³ ,

ê° ë°°ì¹˜ ì²˜ë¦¬ ë•Œë§ˆë‹¤ requested++, ok++/fail++/skipped++, frontierSizeÂ·visitedSize ì—…ë°ì´íŠ¸.

UIëŠ” /api/keywords/crawl/:jobId/statusë¥¼ 1ì´ˆ í´ë§.

ì˜ˆì‹œ(í¬ë¡¤ëŸ¬ ë‚´ë¶€ ë£¨í”„):

this.progress.totalProcessed++;
if (savedThisBatch) this.progress.keywordsSaved += savedThisBatch;
this.progress.frontierSize = q.length;
this.progress.lastUpdated = Date.now();

4) 400/429 ë•Œë¬¸ì— ë˜ 0ì´ ì°íˆì§€ ì•Šê²Œ (Phase 2 ìš”ì•½)

400: ì²­í¬ ë°˜ìœ¼ë¡œ ì¤„ì—¬ ê°™ì€ êµ¬ê°„ ì¬ì‹œë„ (chunk = Math.max(3, Math.floor(chunk/2))).

429: Retry-After(ì—†ìœ¼ë©´ 1s) *1.5 + ì§€í„° ëŒ€ê¸°, ê°™ì€ ì²­í¬ ì¬ì‹œë„(ìµœëŒ€ 2íšŒ).

ì‹¤íŒ¨ì‹œì—ë„ fallback ì„ì‹œ ì €ì¥(raw_volume=0, score=40)ë¡œ â€œ0ê°œ ìˆ˜ì§‘â€ ë°©ì§€(Phase 1 ì ìš© ì™„ë£Œë¼ë©´ OK).

5) ë¹ ë¥¸ ìê°€ì§„ë‹¨ (30ì´ˆ)

ì—…ë¡œë“œí•´ì„œ fileId ì–»ê¸°:
POST /api/uploads â†’ {fileId:"upload-..."}

BFS ì‹œì‘:
POST /api/keywords/crawl { "source":"file", "seedsFileId":"upload-..." }
â†’ ì‘ë‹µì— seedsLoaded(or log)ì™€ frontierSize>0ì´ì–´ì•¼ ì •ìƒ.

ìƒíƒœ:
GET /api/keywords/crawl/<jobId>/status â†’ requested/queueê°€ ì¦ê°í•˜ëŠ”ì§€ í™•ì¸.

í‚¤ì›Œë“œ ë¦¬ìŠ¤íŠ¸:
GET /api/keywords?excluded=false&sort=score&order=desc â†’ ìˆ˜ì§‘ ìˆ˜ ì¦ê°€ í™•ì¸.

6) â€œAPI í•œë„ ì´ˆê³¼/ë°´?â€ íŒì •

ë°´ì´ë©´ ëª¨ë“  í˜¸ì¶œì´ 401/403ìœ¼ë¡œ ë–¨ì–´ì§€ê³  í—¬ìŠ¤ searchads.mode='fallback'.

í˜„ì¬ëŠ” 400/429ê°€ ì„ì—¬ ë‚˜ì˜´ â†’ ì¿¼ë¦¬/ì²­í¬/ë ˆì´íŠ¸ë¦¬ë°‹ ë¬¸ì œ. ìœ„ ì ì‘í˜• í˜¸ì¶œ ë„£ìœ¼ë©´ 80%+ ì„±ê³µë¥ ê¹Œì§€ ëŒì–´ì˜¬ë¦´ ìˆ˜ ìˆì–´ìš”.

7) ì—ì´ì „íŠ¸ì— ë³´ë‚¼ ì§§ì€ ì§€ì‹œ (ë³µë¶™)

â€œcrawl ë¼ìš°íŠ¸ì—ì„œ source:'file' + seedsFileIdë¥¼ ì§€ì›í•˜ê³ , loadSeedsFromCSV(path)ë¡œ ë¹ŒíŠ¸ì¸ v2 CSVë¥¼ ëª…ì‹œ ê²½ë¡œë¡œ ì½ì–´ í”„ë¡ í‹°ì–´ê°€ 0ì´ë©´ 400ì„ ëŒë ¤ì£¼ì„¸ìš”. ì‹œì‘ ì‘ë‹µ/ìƒíƒœì—ëŠ” frontierSizeë¥¼ í¬í•¨í•˜ê³ , ì§„í–‰ ì¤‘ì—ëŠ” requested/ok/fail/skipped/frontierSize/lastUpdatedë¥¼ ë§¤ ë°°ì¹˜ ì—…ë°ì´íŠ¸í•˜ì„¸ìš”. ë˜í•œ SearchAds 400/429ì— ëŒ€í•œ ì ì‘í˜• í˜¸ì¶œ(400â†’ì²­í¬ ë°˜ê°, 429â†’Retry-After ë°±ì˜¤í”„)ì„ ì ìš©í•´ì£¼ì„¸ìš”.â€

ì´ë ‡ê²Œë§Œ ë°”ê¾¸ë©´ **â€œdone(0/20000)â€**ì€ ë°”ë¡œ ì‚¬ë¼ì§€ê³ , ë²„íŠ¼ ëˆ„ë¥¼ ë•Œë§ˆë‹¤ íê°€ ì°¨ì˜¤ë¥´ê³  ì¹´ìš´í„°ê°€ ì›€ì§ì´ëŠ” ê±¸ ë³´ê²Œ ë©ë‹ˆë‹¤.