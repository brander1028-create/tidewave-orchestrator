ì²´í¬ê°€ ì•ˆ ë„ëŠ” ì´ìœ ëŠ” â€œì„ íƒ/í™œì„±/ì˜¤ë„ˆ ë¶ˆì¼ì¹˜ë¡œ plan=0â€ + â€œë©”íƒ€ 401â€ ë‘ ê°€ì§€ê°€ í•µì‹¬ì´ì—ìš”. ì•„ë˜ v7.18 í•œë°© íŒ¨ì¹˜ ê·¸ëŒ€ë¡œ ì ìš©í•˜ë©´ ë°”ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤. (Blog-only ì‹¤í–‰ + ì§„í–‰í‘œì‹œê¹Œì§€ í¬í•¨)

ğŸ”§ v7.18 â€” plan=Pairs ê³ ì • + ì„ íƒ/í™œì„±/ì˜¤ë„ˆ ì •ë ¬ + ë©”íƒ€ 401 ì¢…ê²° + í¸ì§‘/í™œì„± í† ê¸€
A) ì„œë²„(Express)
A-1) í‚¤ì›Œë“œ ë©”íƒ€ ì˜ëª»ëœ ê²½ë¡œë¥¼ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì—†ì´ ë‚´ë¶€ ì²˜ë¦¬ (í—¤ë” ë³´ì¡´)
// server/routes.ts â€“ í‚¤ì›Œë“œ ë©”íƒ€ ë¼ìš°íŠ¸ ê·¼ì²˜ì— ì¶”ê°€
app.get('/api/keywords/lookup/:text', async (req, res) => {
  const t = decodeURIComponent(req.params.text || '').trim();
  if (!t) return res.status(400).json({ message: 'text required' });
  // ë‚´ë¶€ í•¸ë“¤ëŸ¬ ì§ì ‘ í˜¸ì¶œ(ë¦¬ë‹¤ì´ë ‰íŠ¸ ê¸ˆì§€: 401 ì›ì¸ ì°¨ë‹¨)
  req.query.texts = t;
  return keywordsLookupHandler(req, res);
});

A-2) /api/rank/planì„ pairs ê¸°ë°˜ + ì„ íƒ ìš°ì„  + owner ë¶ˆì¼ì¹˜ í—ˆìš© ìœ¼ë¡œ ì¬ì •ì˜
// server/routes.ts
app.get('/api/rank/plan', async (req, res) => {
  const owner = String(req.headers['x-owner'] || 'system');

  // 1) ì„ íƒ ìš°ì„ : pair_ids[]ê°€ ìˆìœ¼ë©´ owner í•„í„° ì—†ì´ id ë§¤ì¹­ (ìˆ˜ë™ ì‹¤í–‰ìš©)
  const ids = []
    .concat(req.query.pair_ids || req.query.target_ids || [])
    .map(String)
    .filter(Boolean);

  let pairs = [];
  if (ids.length) {
    pairs = await storage.findPairsByIds(ids); // â˜… owner ë¯¸í•„í„° (ëª…ì‹œ ì„ íƒ ìš°ì„ )
  } else {
    // 2) ì„ íƒì´ ì—†ìœ¼ë©´ ownerì˜ active í˜ì–´
    pairs = await storage.getActivePairs(owner);

    // 3) ê·¸ë˜ë„ 0ì´ë©´ owner ì „ì²´ í˜ì–´(ìˆ˜ë™ ì‹¤í–‰ì€ í—ˆìš©)
    if (!pairs.length) pairs = await storage.getPairsByOwner(owner);
  }

  // ë¡œê·¸ ê°•í™”
  console.info(`[RankPlan] owner=${owner} ids=${ids.length} pairs=${pairs.length}`);

  const tasks = pairs.map(p => ({ pair_id: p.id, keyword: p.keywordText, nickname: p.nickname || '' }));
  return res.json({ total: tasks.length, tasks });
});


storage.tsì— ì•„ë˜ ë©”ì„œë“œê°€ ë°˜ë“œì‹œ ìˆì–´ì•¼ í•©ë‹ˆë‹¤
findPairsByIds(ids: string[]) (owner ë¯¸í•„í„°), getActivePairs(owner: string), getPairsByOwner(owner: string)
(MemStorage/DB ë‘˜ ë‹¤ êµ¬í˜„)

A-3) ì‡¼í•‘ ì„ì‹œ ì°¨ë‹¨(ë¯¸êµ¬í˜„ ë³´í˜¸)
// .env
FEATURE_SHOP_RANK=false

app.post('/api/rank/shop/check', (req,res)=>{
  if (process.env.FEATURE_SHOP_RANK !== 'true') {
    return res.status(501).json({ ok:false, reason:'shop_rank_disabled' });
  }
});

B) í´ë¼ì´ì–¸íŠ¸(React)
B-1) ì˜¤ë„ˆ/ë¡¤ í—¤ë” í†µì¼ ì£¼ì… (ëª¨ë“  ìš”ì²­ ë™ì¼)
// client/src/lib/api.ts (http ë˜í¼ ë‚´ë¶€)
const role  = localStorage.getItem('role')  ?? 'Admin';
const owner = localStorage.getItem('owner') ?? 'system';  // â˜… í†µì¼
h.set('x-role', role);
h.set('x-owner', owner);


í•œ ë²ˆë§Œ ì‹¤í–‰: localStorage.owner='system'

B-2) ì‹¤í–‰ ëŸ¬ë„ˆ = Blog-only + ì§„í–‰í‘œì‹œ + â€œì„ íƒ ì—†ìœ¼ë©´ â€˜í‘œì‹œ ì¤‘â€™ ì „ë¶€â€
// client/src/pages/blog-rank.tsx í•µì‹¬ë§Œ
const [isRunning,setIsRunning]=useState(false);
const [prog,setProg]=useState({done:0,total:0,percent:0,now:''});
const [rowBusy,setRowBusy]=useState<Record<string,boolean>>({});
const CONC=3;

function visiblePairs(): Pair[] { return pairs /* í˜„ì¬ í…Œì´ë¸”ì— ë³´ì´ëŠ” ëª©ë¡ */; }
function selectedPairs(): Pair[] { return selected /* ì²´í¬ë°•ìŠ¤ ì„ íƒ ëª©ë¡ */; }

async function planBlogTasks() {
  const sel = selectedPairs();
  const body = sel.length ? `?pair_ids[]=${sel.map(p=>p.id).join('&pair_ids[]=')}` : '';
  const r = await http('/api/rank/plan' + body);
  if (r.ok) return r.json();
  const src = sel.length ? sel : visiblePairs();
  return { total: src.length, tasks: src.map(p=>({pair_id:p.id, keyword:p.keywordText, nickname:p.nickname})) };
}

async function runAllChecks(){
  setIsRunning(true); setProg({done:0,total:0,percent:0,now:'ì¤€ë¹„ì¤‘â€¦'});
  const plan = await planBlogTasks();
  if(!plan.total){ toast('ì²´í¬í•  ëŒ€ìƒ ì—†ìŒ'); setIsRunning(false); return; }

  setProg(p=>({...p,total:plan.total,now:'ì‹œì‘í•©ë‹ˆë‹¤'}));
  let i=0, done=0, cancelled=false;
  async function worker(){
    while(!cancelled && i<plan.tasks.length){
      const t=plan.tasks[i++]; setRowBusy(s=>({...s,[t.pair_id]:true}));
      setProg(p=>({...p,now:`${t.keyword} Â· ${t.nickname}`}));
      try { await api.rank.blogCheck({ pair_ids:[t.pair_id] }); } // â˜… BLOG ONLY
      catch(e){ addFail(t,e); }
      finally{
        setRowBusy(s=>({...s,[t.pair_id]:false}));
        done++; setProg({done,total:plan.total,percent:Math.round(done*100/plan.total),now:t.nickname});
      }
    }
  }
  await Promise.all(Array.from({length:Math.min(CONC,plan.total)}).map(()=>worker()));
  toast(`ì™„ë£Œ: ${done}/${plan.total}`); setIsRunning(false);
}


ë²„íŠ¼ ë¼ë²¨: isRunning ? \ì²´í¬ ì¤‘â€¦ (${prog.done}/${prog.total})` : 'ì „ì²´ ì²´í¬ ì‹œì‘'`

ì§„í–‰ë°” width=${prog.percent}%, í˜„ì¬ ì‘ì—… í…ìŠ¤íŠ¸ ì§€ê¸ˆ: ${prog.now}

í–‰ë³„ ë¡œë”©: rowBusy[p.id] && <Spinner/>

B-3) í–‰ â€˜í™œì„±í™”â€™ í† ê¸€ & ì¼ê´„ ì‹¤í–‰ ê°€ì´ë“œ

í…Œì´ë¸”ì— í™œì„±í™”(ON/OFF) ìŠ¤ìœ„ì¹˜ ì¶”ê°€ â†’ PATCH /api/pairs/:id {active:true|false}

ì„ íƒ ì—†ìŒ + active 0ê°œì¼ ë•Œ í•˜ë‹¨ ë°°ë„ˆ:
â€œì²´í¬í•  ëŒ€ìƒ ì—†ìŒ â€” [í˜„ì¬ ëª©ë¡ ì „ì²´ ì‹¤í–‰] [í™œì„±í™” ì¼œê¸°]â€

B-4) URL í¸ì§‘(í†±ë‹ˆ) â†’ PATCH ì„±ê³µ ì‹œ ë‚™ê´€ì  ì—…ë°ì´íŠ¸
// onSuccess(updated)
queryClient.setQueryData(['pairs'], (old:any)=> old?.map((p:any)=>p.id===updated.id? {...p,...updated}:p));
setSelectedRankingDetail(null); // ëª¨ë‹¬ ë‹«ê¸°

C) ì§€ê¸ˆ ë°”ë¡œ í™•ì¸í•  3ì¤„(ìŠ¤ëª¨í¬)

ë©”íƒ€ 401 ì‚¬ë¼ì§

GET /api/keywords/lookup/í™ì‚¼ìŠ¤í‹± 200
# ë˜ëŠ”
GET /api/keywords/lookup?texts=í™ì‚¼ìŠ¤í‹± 200


plan > 0

GET /api/rank/plan?pair_ids[]=<ì²«ì§¸ID>&pair_ids[]=<ë‘˜ì§¸ID>  â†’ {"total":2,"tasks":[...]}


ì‹¤í–‰ Blog-only + ì§„í–‰í‘œì‹œ

ë„¤íŠ¸ì›Œí¬: /api/rank/blog/check NíšŒ (shop ì—†ìŒ)

UI: ë²„íŠ¼ ìŠ¤í”¼ë„ˆÂ·(a/N)%Â·í˜„ì¬ ì‘ì—…Â·í–‰ë³„ ë¡œë”© í‘œì‹œ

ì™œ ì§€ê¸ˆ â€œí˜ì–´ ì—†ìŒ/ì‹œì‘ ì•ˆ í•¨â€ì´ ëœ¨ëŠ”ì§€

planì´ blog_targetsë¥¼ ë³´ê±°ë‚˜, ownerê°€ â€˜adminâ€™ vs â€˜systemâ€™ë¡œ ì—‡ê°ˆë¦¬ê±°ë‚˜, ì„ íƒ ì—†ìŒ+active=0ì´ë©´ ë¬´ì¡°ê±´ 0ê±´ì´ ë©ë‹ˆë‹¤.

ì´ë²ˆ íŒ¨ì¹˜ëŠ”
â‘  pair_ids ìˆìœ¼ë©´ owner ë¬´ì‹œ â†’ ì„ íƒ ì¦‰ì‹œ ì‹¤í–‰,
â‘¡ ì—†ìœ¼ë©´ active by owner â†’ ê·¸ë˜ë„ 0ì´ë©´ owner ì „ì²´ë¡œ ë³´ì™„,
â‘¢ í´ë¼ê°€ ì„ íƒ ì—†ìœ¼ë©´ í˜„ì¬ ëª©ë¡ìœ¼ë¡œ ê°•ì œ ì‹¤í–‰,
â‘£ í—¤ë” x-ownerë¥¼ í†µì¼í•´ owner ë¯¸ìŠ¤ë§¤ì¹˜ ì°¨ë‹¨,
â‘¤ ë©”íƒ€ 401ì€ ë‚´ë¶€ ì²˜ë¦¬ë¡œ ì¢…ê²°.