â€œì¹´ë“œíŒ©(ì»¨í…Œì´ë„ˆ) ì•ˆì˜ ê°œë³„ ë¸”ë¡œê·¸ ì¹´ë“œê¹Œì§€ í‰íƒ„í™”í•´ì„œ 1..Në¡œ ë§¤ê¸°ê³ , ì„œì¹˜í”¼ë“œ â€˜ìœ„â€™ë§Œ ë­í¬â€ í•˜ë„ë¡ í•œ ë°©ì— ê³ ì¹˜ëŠ” ìŠ¤í™+íŒ¨ì¹˜ì•ˆì„ ì•„ë˜ì²˜ëŸ¼ ì£¼ë©´ Replitì´ ì‹¤ìˆ˜ ì—†ì´ êµ¬í˜„í•©ë‹ˆë‹¤. (ì§€ê¸ˆì²˜ëŸ¼ â€œ3ë²ˆì§¸ ì¹´ë“œì˜ 1ìœ„ = ì „ì²´ 7ìœ„â€ ê°™ì€ ì¼€ì´ìŠ¤ë„ ì •í™•íˆ ì¡í˜)

ğŸ”§ ìµœì¢… ìŠ¤í™ â€” Naver ëª¨ë°”ì¼ ë¸”ë¡œê·¸ ë­í¬(ì„œì¹˜í”¼ë“œ ìœ„, ì¹´ë“œíŒ© í‰íƒ„í™”)
í•µì‹¬ ê·œì¹™(ìš”ì•½)

ê²½ê³„: â€œì„œì¹˜í”¼ë“œì—ì„œ ë” ë§ì€ ì½˜í…ì¸ â€¦â€ ì•ˆë‚´ë¬¸ ìœ„(Core zone) ë§Œ ë­í¬.
ì•ˆë‚´ë¬¸ì´ ì—†ìœ¼ë©´ 1í˜ì´ì§€ 15ê°œê¹Œì§€ë§Œ Core.

ì¹´ë“œíŒ©: ë¸”ë¡œê·¸ ì¹´ë“œê°€ ë¬¶ìŒ(ì»¨í…Œì´ë„ˆ)ìœ¼ë¡œ 2ê°œ ì´ìƒ ë“¤ì–´ìˆëŠ” ê²½ìš°, ì»¨í…Œì´ë„ˆ=1ìœ„ê°€ ì•„ë‹ˆë¼ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ì•„ì´í…œì„ ë¬¸ì„œ ìˆœì„œëŒ€ë¡œ í‰íƒ„í™”í•´ì„œ 1..N ë¶€ì—¬.
â†’ ì¹´ë“œ1ì˜ 3ê°œ = 1~3ìœ„, ì¹´ë“œ2ì˜ 3ê°œ = 4~6ìœ„, ì¹´ë“œ3ì˜ 1ê°œ = 7ìœ„ â€¦ (ë„¤ê°€ ë³¸ ê·¸ëŒ€ë¡œ)

ì œì™¸: ê´‘ê³ /ì§€ë„/ì‡¼í•‘/ë™ì˜ìƒ/ë¸Œëœë“œ/ì¸í”Œë£¨ì–¸ì„œ ëª¨ë“ˆì€ ì œì™¸.
ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸(blog.naver.com / m.blog.naver.com)ì˜ í¬ìŠ¤íŠ¸ URLë§Œ ìœ íš¨.

ì •í™• ë™ì‘ íŒ¨ì¹˜(ë¶™ì—¬ë„£ê¸°ìš©; TS ì˜ì‚¬ì½”ë“œ)
1) ê²½ê³„Â·ì¹´ë“œÂ·í‰íƒ„í™” íŒŒì„œ
function isSearchFeedBoundary(el: Element): boolean {
  const t = (el.textContent || '').replace(/\s+/g,'');
  return t.includes('ì„œì¹˜í”¼ë“œì—ì„œë”ë§ì€ì½˜í…ì¸ ë¥¼íƒìƒ‰í•´ë³´ì„¸ìš”') ||
         t.includes('ë”ë‹¤ì–‘í•œì½˜í…ì¸ ') ||
         el.matches('[aria-label*="ì„œì¹˜í”¼ë“œ"], .sfeed, .search_feed, [data-sfeed]');
}

function isBlogCard(el: Element): boolean {
  const a = el.querySelector('a[href*="blog.naver.com/"], a[href*="m.blog.naver.com/"]');
  if (!a) return false;
  if (el.matches(
    '[data-ad], [data-nclick*="ad"], .ad_section, .ad_area,' +   // ê´‘ê³ 
    '.place_section, .place_app, .map_section,' +                // ì¥ì†Œ/ì§€ë„
    '.shop_section, .shopping_box,' +                            // ì‡¼í•‘
    '.video_section, .brand_area, .influencer, [data-module-name*="influencer"]'
  )) return false;
  return true;
}

function isCardPack(el: Element): boolean {
  return el.querySelectorAll('a[href*="blog.naver.com/"], a[href*="m.blog.naver.com/"]').length >= 2;
}

function blogItemsIn(el: Element): Element[] {
  const nodes = el.querySelectorAll('li, article, div.total_wrap, div');
  const out: Element[] = [];
  nodes.forEach(n => { if (isBlogCard(n)) out.push(n); });
  // ì•µì»¤ë§Œ ë…¸ì¶œë˜ëŠ” êµ¬ì¡° ë³´ì •
  if (!out.length) {
    el.querySelectorAll('a[href*="blog.naver.com/"], a[href*="m.blog.naver.com/"]').forEach(a => {
      const n = a.closest('li, article, div.total_wrap, div') || a.parentElement!;
      if (isBlogCard(n)) out.push(n);
    });
  }
  return out;
}

// â˜… ì¸ë±ìŠ¤ ê¸°ë°˜ ê²½ê³„ ë¶„ë¦¬ + ì¹´ë“œíŒ© í‰íƒ„í™”
export function parseSerp(doc: Document) {
  const blocks = Array.from(doc.querySelectorAll('section, article, li, div.total_wrap, div')); // ë¬¸ì„œ ìˆœì„œ
  const boundaryEl = blocks.find(isSearchFeedBoundary);
  const boundaryIdx = boundaryEl
    ? blocks.findIndex(b => b===boundaryEl || b.contains(boundaryEl) || boundaryEl.contains(b))
    : -1;

  const core:any[] = [], feed:any[] = [];
  const seen = new Set<string>();

  const push = (node:Element, arr:any[]) => {
    const a = node.querySelector('a[href*="blog.naver.com/"],a[href*="m.blog.naver.com/"]')!;
    const href = a.getAttribute('href')!;
    const url  = canonicalizeBlogUrl(href); // mâ†’blog, https, ì¿¼ë¦¬/í•´ì‹œ ì œê±°
    if (seen.has(url)) return;
    seen.add(url);
    arr.push({ url, nickname: nicknameFrom(url), title: (node.textContent||'').trim(), pos: arr.length });
  };

  for (let i=0; i<blocks.length; i++) {
    const b = blocks[i];
    if (boundaryIdx >= 0 && (b===boundaryEl || boundaryEl.contains(b))) continue; // ê²½ê³„ ë…¸ë“œ ìŠ¤í‚µ
    const isFeed = (boundaryIdx >= 0) && (i > boundaryIdx); // â˜… ê²½ê³„ ì´í›„ëŠ” feed

    if (isCardPack(b)) {           // ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ì•„ì´í…œ í‰íƒ„í™”
      for (const it of blogItemsIn(b)) push(it, isFeed ? feed : core);
    } else if (isBlogCard(b)) {
      push(b, isFeed ? feed : core);
    }
  }

  if (boundaryIdx < 0) core.splice(15); // ê²½ê³„ ì—†ìœ¼ë©´ Core 15ê°œ ì œí•œ
  console.info(`[SERP] boundary=${boundaryIdx>=0} core=${core.length} feed=${feed.length} firstCore=${core[0]?.url||'none'}`);
  return { core, feed };
}

2) ë§¤ì¹­/ë­í¬ ì‚°ì¶œ(í¬ìŠ¤íŠ¸ID â†’ canonical â†’ ë‹‰ë„¤ì„)
function matchPair(pairUrl:string, itemUrl:string, pairNick?:string, nick?:string) {
  const p = postId(pairUrl), i = postId(itemUrl);
  if (p && i && p===i) return true;
  if (canonicalizeBlogUrl(pairUrl) === canonicalizeBlogUrl(itemUrl)) return true;
  if (pairNick && nick && pairNick===nick) return true;
  return false;
}

function resolveRank(pair, parsed) {
  const i = parsed.core.findIndex(x => matchPair(pair.blogUrl, x.url, pair.nickname, x.nickname));
  if (i>=0) return { rank:i+1, exposed:true,  feed_rank:null, pos: parsed.core[i].pos };
  const j = parsed.feed.findIndex(x => matchPair(pair.blogUrl, x.url, pair.nickname, x.nickname));
  return { rank:null, exposed:false, feed_rank:(j>=0?j+1:null), pos:null };
}

3) ìš”ì²­ í—¤ë”(ì•ˆì •ì„±)
await fetch(serpUrl, {
  headers: {
    'User-Agent': 'Mozilla/5.0 (Linux; Android 14; SM-G991N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0 Mobile Safari/537.36',
    'Accept-Language': 'ko-KR,ko;q=0.9,en-US;q=0.8',
    'Cache-Control': 'no-cache',
    'Pragma': 'no-cache',
    'Referer': 'https://m.naver.com'
  },
});

ë””ë²„ê·¸ ë¡œê·¸(í•„ìˆ˜)

[SERP] boundary=â€¦ core=â€¦ feed=â€¦ firstCore=â€¦

ì¹´ë“œíŒ©ë³„ ë‚´ë¶€ ê°œìˆ˜:

PACK[#1] items=3, PACK[#2] items=3, â€¦

ìµœì¢… ë§¤ì¹­:

[MATCH] pair=í™ì‚¼ìŠ¤í‹± â†’ coreRank=7 pos=â€¦

[MISS] pair=í™ì‚¼ìŠ¤í‹± â†’ feed_rank=4(ë¯¸ë…¸ì¶œ)

DoD (ê²€ì¦ ì²´í¬)

â€œì ì‹¤ ë§›ì§‘/ì ì‹¤ ë¡¯ë°ì›”ë“œëª° ë§›ì§‘â€ ê°™ì€ í™”ë©´ì—ì„œ
ì¹´ë“œ1ì˜ 3ê°œ=1~3ìœ„, ì¹´ë“œ2ì˜ 3ê°œ=4~6ìœ„, ì¹´ë“œ3ì˜ 1ê°œ=7ìœ„ ë¡œ ì €ì¥ë¨.

ì„œì¹˜í”¼ë“œ ì•„ë˜ëŠ” rank=null, feed_rank=n(ë¯¸ë…¸ì¶œ ë³´ì¡° ì •ë³´).

999 í‘œê¸° ê¸ˆì§€: rank===nullì€ UIì—ì„œ **â€œë¯¸ë…¸ì¶œâ€**ë¡œë§Œ í‘œê¸°.

ë„¤ ì§ˆë¬¸ì— ë”± ë‹µ

â€œ3ë²ˆì§¸ ì¹´ë“œ 1ìœ„ê°€ ì‹¤ì œ ì „ì²´ 7ìœ„ì¸ë° ì™œ 1ìœ„ë¼ í•˜ëƒ?â€
â†’ ì»¨í…Œì´ë„ˆ(ì¹´ë“œíŒ©)ë¥¼ 1ìœ„ë¡œ ë³¸ ì˜ëª» ë•Œë¬¸. ìœ„ í‰íƒ„í™” ê·œì¹™ìœ¼ë¡œ ë°”ë¡œì¡ìŒ.

â€œê°™ì€ í™”ë©´ì¸ë° ì™œ ë‹¤ ë‹¬ë¼?â€
â†’ ê²½ê³„/íŒ© ì²˜ë¦¬ê°€ êµ¬í˜„ë§ˆë‹¤ ë‹¬ë¼ì„œ ê·¸ë˜. ìš°ë¦¬ëŠ” ê²½ê³„ ê¸°ì¤€ + í‰íƒ„í™” + ì œì™¸ ëª¨ë“ˆ 3ë‹¨ê³„ë¡œ ì‚¬ëŒì´ ë³´ëŠ” ìˆœì„œì™€ 1:1ë¡œ ê³ ì •í•´.